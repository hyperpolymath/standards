; ============================================================
; META Format - Augmented Backus-Naur Form (ABNF) Grammar
; ============================================================
;
; SPDX-License-Identifier: MIT
; Copyright (c) 2025 Jonathan D.A. Jewell
;
; This grammar defines the META.scm file format for machine-readable
; project metadata, architecture decisions, and development practices.
;
; Reference: RFC 5234 (ABNF), RFC 7405 (Case-Sensitive Strings)
; Target: IETF Informational RFC
;
; ============================================================


; ------------------------------------------------------------
; Top-Level Structure
; ------------------------------------------------------------

meta-file           = *comment module-declaration *comment
                      *section-definition

module-declaration  = "(" "define-module" SP module-path
                      *module-directive ")"

module-path         = "(" 1*module-segment ")"
module-segment      = symbol
module-directive    = export-directive / use-directive / other-directive

export-directive    = "#:export" SP "(" *symbol ")"
use-directive       = "#:use-module" SP module-path
other-directive     = keyword SP s-expression


; ------------------------------------------------------------
; Section Definitions
; ------------------------------------------------------------

section-definition  = definition

definition          = "(" "define" SP symbol SP s-expression ")"


; ------------------------------------------------------------
; Core Sections (Recommended)
; ------------------------------------------------------------

; Architecture Decisions Record (ADR) Section
; Example: (define architecture-decisions '(...))

adr-section         = "(" "define" SP %s"architecture-decisions"
                      SP adr-list ")"

adr-list            = quoted-list
adr-entry           = "(" adr-id *adr-field ")"
adr-id              = symbol                          ; e.g., adr-001
adr-field           = "(" field-key SP "." SP field-value ")"

; Standard ADR fields
adr-field-key       = %s"title" / %s"status" / %s"date"
                    / %s"context" / %s"decision" / %s"consequences"
                    / %s"supersedes" / %s"superseded-by"
                    / extension-field-key

; ADR status values
adr-status          = %s"proposed" / %s"accepted" / %s"deprecated"
                    / %s"superseded" / %s"rejected"


; Development Practices Section
; Example: (define development-practices '(...))

practices-section   = "(" "define" SP %s"development-practices"
                      SP practices-list ")"

practices-list      = quoted-list
practice-entry      = "(" practice-category *practice-field ")"

; Standard practice categories
practice-category   = %s"code-style" / %s"security" / %s"documentation"
                    / %s"testing" / %s"versioning" / %s"deployment"
                    / %s"review" / %s"branching" / extension-category


; Design Rationale Section
; Example: (define design-rationale '(...))

rationale-section   = "(" "define" SP %s"design-rationale"
                      SP rationale-list ")"

rationale-list      = quoted-list
rationale-entry     = "(" rationale-key SP rationale-text ")"
rationale-key       = symbol                          ; e.g., why-multiple-runtimes
rationale-text      = string


; ------------------------------------------------------------
; Extension Sections (Optional)
; ------------------------------------------------------------

; Projects may define additional sections following this pattern
extension-section   = "(" "define" SP extension-symbol SP s-expression ")"
extension-symbol    = symbol                          ; Must not conflict with core
extension-field-key = symbol
extension-category  = symbol


; ------------------------------------------------------------
; S-Expression Primitives
; ------------------------------------------------------------

s-expression        = atom / list / quoted-expression / quasi-expression

atom                = symbol / string / number / boolean / keyword

list                = "(" *s-expression ")"
quoted-list         = "'" list                        ; Shorthand for (quote ...)
quoted-expression   = "'" s-expression
quasi-expression    = "`" s-expression                ; Quasiquote

; Symbols
symbol              = symbol-initial *symbol-subsequent
symbol-initial      = ALPHA / special-initial
symbol-subsequent   = symbol-initial / DIGIT / special-subsequent
special-initial     = "!" / "$" / "%" / "&" / "*" / "/" / ":"
                    / "<" / "=" / ">" / "?" / "^" / "_" / "~"
special-subsequent  = "+" / "-" / "." / "@"

; Keywords (Scheme #:keyword syntax)
keyword             = "#:" symbol

; Strings
string              = DQUOTE *string-char DQUOTE
string-char         = %x20-21 / %x23-5B / %x5D-7E    ; Printable except " and \
                    / escape-sequence
                    / string-continuation

escape-sequence     = "\" ( DQUOTE / "\" / "/" / "b" / "f" / "n" / "r" / "t" )
                    / unicode-escape
unicode-escape      = "\u" 4HEXDIG

string-continuation = "\" *WSP CRLF *WSP             ; Multi-line strings

; Numbers
number              = integer / decimal / rational / complex-num
integer             = [sign] 1*DIGIT
decimal             = [sign] *DIGIT "." 1*DIGIT [exponent]
exponent            = ("e" / "E") [sign] 1*DIGIT
rational            = integer "/" positive-integer
complex-num         = number [sign number "i"]
positive-integer    = %x31-39 *DIGIT                 ; 1-9 followed by digits
sign                = "+" / "-"

; Booleans
boolean             = "#t" / "#f" / "#true" / "#false"


; ------------------------------------------------------------
; Comments and Whitespace
; ------------------------------------------------------------

comment             = line-comment / block-comment / doc-comment

; Standard line comment
line-comment        = ";" *(%x20-7E / HTAB) (CRLF / LF)

; Block comment (SRFI-30 style)
block-comment       = "#|" *block-content "|#"
block-content       = *( %x00-7F )                   ; Nested allowed

; Documentation comments (convention)
doc-comment         = ";;;" SP *(%x20-7E / HTAB) (CRLF / LF)

; Whitespace
WS                  = SP / HTAB / CRLF / LF
SP                  = %x20                            ; Space
HTAB                = %x09                            ; Horizontal tab
CRLF                = %x0D %x0A                       ; Carriage return + line feed
LF                  = %x0A                            ; Line feed only


; ------------------------------------------------------------
; Field Types for Structured Data
; ------------------------------------------------------------

field-key           = symbol
field-value         = string / symbol / number / list / dotted-pair

dotted-pair         = "(" field-key SP "." SP field-value ")"

; Association list (common pattern)
alist               = "(" *alist-entry ")"
alist-entry         = "(" field-key SP "." SP field-value ")"


; ------------------------------------------------------------
; Date and Time (ISO 8601 subset)
; ------------------------------------------------------------

date                = year "-" month "-" day
year                = 4DIGIT
month               = ("0" %x31-39) / ("1" %x30-32)  ; 01-12
day                 = ("0" %x31-39) / (%x31-32 DIGIT) / ("3" %x30-31)

datetime            = date "T" time [timezone]
time                = hour ":" minute [":" second]
hour                = (%x30-31 DIGIT) / ("2" %x30-33) ; 00-23
minute              = %x30-35 DIGIT                   ; 00-59
second              = %x30-35 DIGIT                   ; 00-59
timezone            = "Z" / ("+" / "-") hour ":" minute


; ------------------------------------------------------------
; Semantic Version (SemVer 2.0.0)
; ------------------------------------------------------------

semver              = major "." minor "." patch ["-" prerelease] ["+" build]
major               = "0" / (%x31-39 *DIGIT)
minor               = "0" / (%x31-39 *DIGIT)
patch               = "0" / (%x31-39 *DIGIT)
prerelease          = prerelease-id *("." prerelease-id)
prerelease-id       = 1*(%x30-39 / ALPHA / "-")
build               = build-id *("." build-id)
build-id            = 1*(%x30-39 / ALPHA / "-")


; ------------------------------------------------------------
; URI Reference (RFC 3986 simplified)
; ------------------------------------------------------------

uri                 = scheme ":" hier-part ["?" query] ["#" fragment]
scheme              = ALPHA *( ALPHA / DIGIT / "+" / "-" / "." )
hier-part           = "//" authority path-abempty
                    / path-absolute / path-rootless / path-empty
authority           = [userinfo "@"] host [":" port]
userinfo            = *( unreserved / pct-encoded / sub-delims / ":" )
host                = reg-name                        ; Simplified
reg-name            = *( unreserved / pct-encoded / sub-delims )
port                = *DIGIT
path-abempty        = *( "/" segment )
path-absolute       = "/" [ segment-nz *( "/" segment ) ]
path-rootless       = segment-nz *( "/" segment )
path-empty          = ""
segment             = *pchar
segment-nz          = 1*pchar
pchar               = unreserved / pct-encoded / sub-delims / ":" / "@"
query               = *( pchar / "/" / "?" )
fragment            = *( pchar / "/" / "?" )
unreserved          = ALPHA / DIGIT / "-" / "." / "_" / "~"
pct-encoded         = "%" HEXDIG HEXDIG
sub-delims          = "!" / "$" / "&" / "'" / "(" / ")"
                    / "*" / "+" / "," / ";" / "="


; ------------------------------------------------------------
; SPDX License Expression (simplified)
; ------------------------------------------------------------

spdx-expression     = spdx-license *( spdx-operator spdx-license )
spdx-license        = spdx-id / "(" spdx-expression ")"
spdx-id             = 1*(ALPHA / DIGIT / "-" / ".")   ; e.g., MIT, Apache-2.0
spdx-operator       = SP ("AND" / "OR" / "WITH") SP


; ------------------------------------------------------------
; Core ABNF Rules (RFC 5234)
; ------------------------------------------------------------

ALPHA               = %x41-5A / %x61-7A               ; A-Z / a-z
DIGIT               = %x30-39                         ; 0-9
HEXDIG              = DIGIT / "A" / "B" / "C" / "D" / "E" / "F"
                    / "a" / "b" / "c" / "d" / "e" / "f"
DQUOTE              = %x22                            ; "


; ============================================================
; END OF GRAMMAR
; ============================================================
