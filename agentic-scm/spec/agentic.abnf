; SPDX-License-Identifier: AGPL-3.0-or-later
; SPDX-FileCopyrightText: 2026 Jonathan D.A. Jewell
;
; AGENTIC.scm ABNF Grammar
; RFC 5234 compliant Augmented Backus-Naur Form
;
; This grammar formally defines the syntax of AGENTIC.scm files
; for operational gating of AI agents.

; ==============================================================
; TOP-LEVEL STRUCTURE
; ==============================================================

agentic-file       = header-comments module-declaration *policy-definition

header-comments    = spdx-license spdx-copyright [file-description]
spdx-license       = ";; SPDX-License-Identifier:" SP license-id LF
spdx-copyright     = ";; SPDX-FileCopyrightText:" SP year SP author LF
file-description   = ";;;" SP description LF [";;;" SP project-name LF]

license-id         = 1*( ALPHA / DIGIT / "-" / "." / "+" )
year               = 4DIGIT
author             = 1*VCHAR
description        = 1*VCHAR
project-name       = 1*VCHAR

; ==============================================================
; MODULE DECLARATION
; ==============================================================

module-declaration = "(" "define-module" SP module-path SP
                     "#:export" SP export-list ")" LF

module-path        = "(" symbol 1*( SP symbol ) ")"
export-list        = "(" 1*( symbol [ SP ] ) ")"

; ==============================================================
; POLICY DEFINITIONS
; ==============================================================

policy-definition  = gating-policies
                   / entropy-budgets
                   / risk-thresholds
                   / override-paths
                   / decision-recording

; --------------------------------------------------------------
; Gating Policies
; --------------------------------------------------------------

gating-policies    = "(" "define" SP "gating-policies" LF
                     SP quoted-list ")" LF

quoted-list        = "'" "(" *policy-entry ")"
policy-entry       = "(" symbol LF *property-pair ")" LF

property-pair      = SP "(" symbol SP "." SP value ")" LF
value              = string / boolean / symbol / number / list

; Gate mode values
gate-mode          = %s"auto"
                   / %s"confirm-if-external"
                   / %s"require-confirmation"
                   / %s"require-explicit-intent"
                   / %s"deny"
                   / %s"deny-without-override"

; --------------------------------------------------------------
; Entropy Budgets
; --------------------------------------------------------------

entropy-budgets    = "(" "define" SP "entropy-budgets" LF
                     SP quoted-list ")" LF

entropy-entry      = session-budget / daily-budget / operation-costs / thresholds
session-budget     = "(" %s"session" LF *budget-property ")"
daily-budget       = "(" %s"daily" LF *budget-property ")"
budget-property    = SP "(" budget-key SP "." SP budget-value ")" LF
budget-key         = %s"max-entropy" / %s"current" / %s"reset-on" / %s"carry-over"
budget-value       = number / string / boolean

operation-costs    = "(" %s"operation-costs" LF *cost-entry ")"
cost-entry         = SP "(" operation-name SP "." SP number ")" LF
operation-name     = symbol

thresholds         = "(" %s"thresholds" LF *threshold-entry ")"
threshold-entry    = SP "(" threshold-spec ")" LF
threshold-spec     = "(" %s"level" SP string ")" SP
                     "(" %s"max" SP "." SP number ")" SP
                     "(" %s"mode" SP "." SP string ")"

; --------------------------------------------------------------
; Risk Thresholds
; --------------------------------------------------------------

risk-thresholds    = "(" "define" SP "risk-thresholds" LF
                     SP quoted-list ")" LF

risk-entry         = categories / classification-rules
categories         = "(" %s"categories" LF *category-def ")"
category-def       = SP "(" category-spec ")" LF
category-spec      = "(" %s"category" SP string ")" LF
                     SP "(" %s"description" SP "." SP string ")" LF
                     SP "(" %s"gate" SP "." SP string ")"
                     [ LF SP "(" %s"entropy-multiplier" SP "." SP number ")" ]

classification-rules = "(" %s"classification-rules" LF *classification-rule ")"
classification-rule  = SP "(" "(" %s"pattern" SP pattern-string ")"
                        SP "(" %s"category" SP "." SP string ")" ")" LF
pattern-string     = DQUOTE pattern-content DQUOTE
pattern-content    = 1*( VCHAR / "*" / ":" )

; --------------------------------------------------------------
; Override Paths
; --------------------------------------------------------------

override-paths     = "(" "define" SP "override-paths" LF
                     SP quoted-list ")" LF

override-entry     = requirements / permitted-overrides / never-override
requirements       = "(" %s"requirements" LF *requirement-property ")"
requirement-property = SP "(" requirement-key SP "." SP boolean ")" LF
requirement-key    = %s"meta-permits"
                   / %s"explicit-present-intent"
                   / %s"proof-or-retype"
                   / %s"record-override"

permitted-overrides = "(" %s"permitted-overrides" LF *override-class ")"
override-class     = SP "(" override-class-spec ")" LF
override-class-spec = "(" %s"class" SP string ")" LF
                      [ SP "(" %s"description" SP "." SP string ")" LF ]
                      SP "(" %s"meta-rule" SP "." SP string ")" LF
                      SP "(" %s"requires" SP "." SP string-list ")" LF
                      SP "(" %s"retype-to" SP "." SP ( string / boolean ) ")"
                      [ LF SP "(" %s"log-level" SP "." SP string ")" ]

never-override     = "(" %s"never-override" LF SP string-list ")"
string-list        = "(" 1*( string [ LF SP ] ) ")"

; --------------------------------------------------------------
; Decision Recording
; --------------------------------------------------------------

decision-recording = "(" "define" SP "decision-recording" LF
                     SP quoted-list ")" LF

recording-entry    = recording-property / sensitive-fields / record-format / alerts
recording-property = "(" recording-key SP "." SP ( boolean / number ) ")"
recording-key      = %s"enabled" / %s"log-all" / %s"include-context" / %s"retention-days"

sensitive-fields   = "(" %s"sensitive-fields" LF SP string-list ")"

record-format      = "(" %s"record-format" LF *field-spec ")"
field-spec         = SP "(" "(" %s"field" SP string ")"
                        SP "(" %s"format" SP "." SP string ")" ")" LF

alerts             = "(" %s"alerts" LF *alert-spec ")"
alert-spec         = SP "(" "(" %s"condition" SP string ")"
                        SP "(" %s"notify" SP "." SP string ")" ")" LF

; ==============================================================
; PRIMITIVE TYPES
; ==============================================================

symbol             = symbol-initial *symbol-subsequent
symbol-initial     = ALPHA / special-initial
symbol-subsequent  = symbol-initial / DIGIT / special-subsequent
special-initial    = "!" / "$" / "%" / "&" / "*" / "/" / ":"
                   / "<" / "=" / ">" / "?" / "^" / "_" / "~"
special-subsequent = "+" / "-" / "." / "@"

string             = DQUOTE *string-char DQUOTE
string-char        = %x20-21 / %x23-5B / %x5D-7E / escape-sequence
escape-sequence    = "\" ( DQUOTE / "\" / "n" / "r" / "t" )

number             = [ "-" ] 1*DIGIT [ "." 1*DIGIT ]
boolean            = "#t" / "#f"
list               = "(" *( value [ SP ] ) ")"

; ==============================================================
; LEXICAL RULES
; ==============================================================

SP                 = %x20              ; space
LF                 = %x0A              ; line feed
HTAB               = %x09              ; horizontal tab
WSP                = SP / HTAB
ALPHA              = %x41-5A / %x61-7A ; A-Z / a-z
DIGIT              = %x30-39           ; 0-9
VCHAR              = %x21-7E           ; visible characters
DQUOTE             = %x22              ; "

; Comments (not captured, for reference)
comment            = ";;" *VCHAR LF
doc-comment        = ";;;" *VCHAR LF

; ==============================================================
; END OF GRAMMAR
; ==============================================================
