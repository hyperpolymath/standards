{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://hyperpolymath.github.io/agentic-scm/agentic.schema.json",
  "title": "AGENTIC Format Schema",
  "description": "JSON Schema for AGENTIC.scm operational gating policies (JSON representation)",
  "type": "object",
  "required": ["gating-policies"],
  "additionalProperties": false,
  "properties": {
    "$schema": {
      "type": "string",
      "format": "uri"
    },
    "metadata": {
      "$ref": "#/$defs/metadata"
    },
    "gating-policies": {
      "$ref": "#/$defs/gating-policies"
    },
    "entropy-budgets": {
      "$ref": "#/$defs/entropy-budgets"
    },
    "risk-thresholds": {
      "$ref": "#/$defs/risk-thresholds"
    },
    "override-paths": {
      "$ref": "#/$defs/override-paths"
    },
    "decision-recording": {
      "$ref": "#/$defs/decision-recording"
    }
  },
  "$defs": {
    "metadata": {
      "type": "object",
      "description": "File metadata including license and authorship",
      "properties": {
        "spdx-license": {
          "type": "string",
          "description": "SPDX license identifier",
          "examples": ["AGPL-3.0-or-later", "MIT", "Apache-2.0"]
        },
        "spdx-copyright": {
          "type": "string",
          "description": "SPDX copyright text",
          "examples": ["2025 Jonathan D.A. Jewell"]
        },
        "project": {
          "type": "string",
          "description": "Project name"
        },
        "version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+(-[a-zA-Z0-9.]+)?$",
          "description": "Semantic version of this AGENTIC file"
        }
      }
    },
    "gate-mode": {
      "type": "string",
      "enum": [
        "auto",
        "confirm-if-external",
        "require-confirmation",
        "require-explicit-intent",
        "deny",
        "deny-without-override"
      ],
      "description": "Gating mode determining required confirmation level"
    },
    "gating-policies": {
      "type": "object",
      "description": "Rules for when actions may proceed",
      "properties": {
        "default": {
          "type": "object",
          "description": "Default policy settings",
          "properties": {
            "mode": {
              "$ref": "#/$defs/gate-mode"
            },
            "require-explicit-intent": {
              "type": "boolean",
              "default": true
            },
            "log-all-decisions": {
              "type": "boolean",
              "default": true
            },
            "subordinate-to": {
              "type": "string",
              "description": "Reference to governing META file"
            }
          },
          "required": ["mode"]
        },
        "file-operations": {
          "type": "object",
          "description": "Gating policies for file system operations",
          "additionalProperties": {
            "$ref": "#/$defs/gate-mode"
          }
        },
        "network-operations": {
          "type": "object",
          "description": "Gating policies for network operations",
          "additionalProperties": {
            "$ref": "#/$defs/gate-mode"
          }
        },
        "state-mutations": {
          "type": "object",
          "description": "Gating policies for state mutation operations",
          "additionalProperties": {
            "$ref": "#/$defs/gate-mode"
          }
        },
        "tool-permissions": {
          "type": "object",
          "description": "Gating policies for tool invocations",
          "additionalProperties": {
            "$ref": "#/$defs/gate-mode"
          }
        }
      },
      "required": ["default"]
    },
    "entropy-budgets": {
      "type": "object",
      "description": "Accumulated operational risk tracking",
      "properties": {
        "session": {
          "$ref": "#/$defs/budget-config"
        },
        "daily": {
          "$ref": "#/$defs/budget-config"
        },
        "operation-costs": {
          "type": "object",
          "description": "Entropy cost per operation type",
          "additionalProperties": {
            "type": "integer",
            "minimum": 0
          }
        },
        "thresholds": {
          "type": "array",
          "description": "Threshold-based mode changes",
          "items": {
            "$ref": "#/$defs/threshold-entry"
          }
        }
      }
    },
    "budget-config": {
      "type": "object",
      "description": "Budget configuration for a time period",
      "properties": {
        "max-entropy": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum entropy allowed in this period"
        },
        "current": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Current accumulated entropy"
        },
        "reset-on": {
          "type": "string",
          "description": "Event or time that resets the budget",
          "examples": ["session-end", "midnight-utc"]
        },
        "carry-over": {
          "type": "boolean",
          "default": false,
          "description": "Whether unused budget carries to next period"
        }
      },
      "required": ["max-entropy"]
    },
    "threshold-entry": {
      "type": "object",
      "description": "Entropy threshold level definition",
      "properties": {
        "level": {
          "type": "string",
          "description": "Human-readable level name",
          "examples": ["green", "yellow", "orange", "red", "low", "medium", "high", "critical"]
        },
        "max": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum entropy for this level"
        },
        "mode": {
          "type": "string",
          "description": "Gating mode when at this level"
        }
      },
      "required": ["level", "max", "mode"]
    },
    "risk-thresholds": {
      "type": "object",
      "description": "Risk classification for operations",
      "properties": {
        "categories": {
          "type": "array",
          "description": "Risk category definitions",
          "items": {
            "$ref": "#/$defs/risk-category"
          }
        },
        "classification-rules": {
          "type": "array",
          "description": "Pattern-based operation classification",
          "items": {
            "$ref": "#/$defs/classification-rule"
          }
        }
      }
    },
    "risk-category": {
      "type": "object",
      "description": "Definition of a risk category",
      "properties": {
        "category": {
          "type": "string",
          "enum": ["minimal", "low", "medium", "high", "critical"]
        },
        "description": {
          "type": "string"
        },
        "gate": {
          "$ref": "#/$defs/gate-mode"
        },
        "entropy-multiplier": {
          "type": "number",
          "minimum": 0,
          "default": 1
        }
      },
      "required": ["category", "gate"]
    },
    "classification-rule": {
      "type": "object",
      "description": "Rule for classifying operations by pattern",
      "properties": {
        "pattern": {
          "type": "string",
          "description": "Glob-style pattern for matching operations",
          "examples": ["file:read:*", "network:external:*", "state:mutate:irreversible"]
        },
        "category": {
          "type": "string",
          "enum": ["minimal", "low", "medium", "high", "critical"]
        }
      },
      "required": ["pattern", "category"]
    },
    "override-paths": {
      "type": "object",
      "description": "When and how gating may be bypassed",
      "properties": {
        "requirements": {
          "type": "object",
          "description": "Base requirements for any override",
          "properties": {
            "meta-permits": {
              "type": "boolean",
              "description": "META must define the override class"
            },
            "explicit-present-intent": {
              "type": "boolean",
              "description": "User must provide explicit current intent"
            },
            "proof-or-retype": {
              "type": "boolean",
              "description": "Action must be retyped if proof not discharged"
            },
            "record-override": {
              "type": "boolean",
              "description": "Override must be recorded in audit trail"
            }
          }
        },
        "permitted-overrides": {
          "type": "array",
          "description": "Defined override classes",
          "items": {
            "$ref": "#/$defs/override-class"
          }
        },
        "never-override": {
          "type": "array",
          "description": "Operations that can never be overridden",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "override-class": {
      "type": "object",
      "description": "Definition of a permitted override type",
      "properties": {
        "class": {
          "type": "string",
          "description": "Unique identifier for this override class"
        },
        "description": {
          "type": "string"
        },
        "meta-rule": {
          "type": "string",
          "description": "Reference to META ADR that permits this override"
        },
        "requires": {
          "type": "array",
          "description": "Required confirmations for this override",
          "items": {
            "type": "string",
            "enum": ["explicit-intent", "confirmation", "acknowledgement", "reason"]
          }
        },
        "retype-to": {
          "oneOf": [
            {"type": "string"},
            {"type": "boolean", "const": false}
          ],
          "description": "Type annotation after override, or false if unchanged"
        },
        "log-level": {
          "type": "string",
          "enum": ["debug", "info", "warning", "error"],
          "default": "info"
        }
      },
      "required": ["class", "meta-rule", "requires"]
    },
    "decision-recording": {
      "type": "object",
      "description": "Audit trail configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true
        },
        "log-all": {
          "type": "boolean",
          "default": true,
          "description": "Log all decisions, not just denials"
        },
        "include-context": {
          "type": "boolean",
          "default": true,
          "description": "Include operation context in logs"
        },
        "retention-days": {
          "type": "integer",
          "minimum": 1,
          "description": "Days to retain decision logs"
        },
        "sensitive-fields": {
          "type": "array",
          "description": "Field names to redact in logs",
          "items": {
            "type": "string"
          }
        },
        "record-format": {
          "type": "array",
          "description": "Log record field definitions",
          "items": {
            "$ref": "#/$defs/record-field"
          }
        },
        "alerts": {
          "type": "array",
          "description": "Alert configuration",
          "items": {
            "$ref": "#/$defs/alert-config"
          }
        }
      }
    },
    "record-field": {
      "type": "object",
      "description": "Definition of a log record field",
      "properties": {
        "field": {
          "type": "string"
        },
        "format": {
          "type": "string",
          "description": "Expected format of field value"
        }
      },
      "required": ["field", "format"]
    },
    "alert-config": {
      "type": "object",
      "description": "Alert trigger configuration",
      "properties": {
        "condition": {
          "type": "string",
          "description": "Condition that triggers alert"
        },
        "notify": {
          "type": "string",
          "description": "Team or channel to notify"
        }
      },
      "required": ["condition", "notify"]
    }
  }
}
