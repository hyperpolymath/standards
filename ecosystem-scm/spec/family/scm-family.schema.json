{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://scm.family/schema/1.0.0/scm-family.schema.json",
  "title": "SCM Format Family Schema",
  "description": "Unified JSON Schema for validating any SCM Format Family document (STATE.scm, ECOSYSTEM.scm, etc.)",

  "oneOf": [
    { "$ref": "#/$defs/stateDocument" },
    { "$ref": "#/$defs/ecosystemDocument" }
  ],

  "$defs": {
    "stateDocument": {
      "type": "object",
      "description": "STATE.scm document for session state persistence",
      "required": ["metadata"],
      "properties": {
        "_format": {
          "const": "state",
          "description": "Format identifier (implicit in S-expression, explicit in JSON)"
        },
        "metadata": { "$ref": "#/$defs/stateMetadata" },
        "user": { "$ref": "#/$defs/stateUser" },
        "session": { "$ref": "#/$defs/stateSession" },
        "focus": { "$ref": "#/$defs/stateFocus" },
        "projects": {
          "type": "array",
          "items": { "$ref": "#/$defs/stateProject" }
        },
        "history": { "$ref": "#/$defs/stateHistory" },
        "next-actions": {
          "type": "array",
          "items": { "$ref": "#/$defs/stateAction" }
        },
        "issues": {
          "type": "array",
          "items": { "$ref": "#/$defs/stateIssue" }
        },
        "decisions": {
          "type": "array",
          "items": { "$ref": "#/$defs/stateDecision" }
        }
      },
      "patternProperties": {
        "^x-": { "description": "Extension field" }
      },
      "additionalProperties": true
    },

    "ecosystemDocument": {
      "type": "object",
      "description": "ECOSYSTEM.scm document for project ecosystem context",
      "required": ["version", "name", "type", "purpose"],
      "properties": {
        "_format": {
          "const": "ecosystem",
          "description": "Format identifier (implicit in S-expression, explicit in JSON)"
        },
        "version": { "$ref": "#/$defs/semver" },
        "name": { "type": "string", "minLength": 1 },
        "type": { "$ref": "#/$defs/projectType" },
        "purpose": { "type": "string", "minLength": 1 },
        "family": { "$ref": "#/$defs/familyMembership" },
        "position-in-ecosystem": { "type": "string" },
        "related-projects": {
          "type": "array",
          "items": { "$ref": "#/$defs/relatedProject" }
        },
        "what-this-is": { "type": "string" },
        "what-this-is-not": { "type": "string" },
        "specification": { "$ref": "#/$defs/specificationMeta" },
        "standards-track": { "$ref": "#/$defs/standardsTrack" },
        "future-integration": { "type": "string" }
      },
      "patternProperties": {
        "^x-": { "description": "Extension field" }
      },
      "additionalProperties": true
    },

    "stateMetadata": {
      "type": "object",
      "required": ["version"],
      "properties": {
        "version": { "type": "string" },
        "created": { "$ref": "#/$defs/datetime" },
        "modified": { "$ref": "#/$defs/datetime" },
        "generator": { "type": "string" },
        "ecosystem-ref": { "type": "string", "format": "uri-reference" }
      }
    },

    "stateUser": {
      "type": "object",
      "properties": {
        "name": { "type": "string" },
        "roles": { "type": "array", "items": { "type": "string" } },
        "preferences": { "type": "object" },
        "values": { "type": "array", "items": { "type": "string" } }
      }
    },

    "stateSession": {
      "type": "object",
      "properties": {
        "conversation-id": { "type": "string" },
        "message-count": { "type": "integer", "minimum": 0 },
        "token-limit": { "type": "integer" },
        "tokens-used": { "type": "integer" }
      }
    },

    "stateFocus": {
      "type": "object",
      "properties": {
        "project": { "type": "string" },
        "phase": { "type": "string" },
        "deadline": { "$ref": "#/$defs/datetime" },
        "blockers": { "type": "array", "items": { "type": "string" } }
      }
    },

    "stateProject": {
      "type": "object",
      "required": ["name", "status"],
      "properties": {
        "name": { "type": "string" },
        "status": {
          "type": "string",
          "enum": ["in-progress", "blocked", "paused", "complete", "abandoned"]
        },
        "completion": { "type": "number", "minimum": 0, "maximum": 100 },
        "category": { "type": "string" },
        "phase": { "type": "string" },
        "dependencies": { "type": "array", "items": { "type": "string" } },
        "blockers": { "type": "array", "items": { "type": "string" } },
        "next-actions": { "type": "array", "items": { "type": "string" } }
      }
    },

    "stateHistory": {
      "type": "object",
      "properties": {
        "snapshots": {
          "type": "array",
          "items": { "$ref": "#/$defs/stateSnapshot" }
        }
      }
    },

    "stateSnapshot": {
      "type": "object",
      "properties": {
        "timestamp": { "$ref": "#/$defs/datetime" },
        "projects": { "type": "object" }
      }
    },

    "stateAction": {
      "type": "object",
      "required": ["description"],
      "properties": {
        "description": { "type": "string" },
        "priority": { "type": "string", "enum": ["critical", "high", "medium", "low"] },
        "deadline": { "$ref": "#/$defs/datetime" },
        "project": { "type": "string" }
      }
    },

    "stateIssue": {
      "type": "object",
      "required": ["id", "description"],
      "properties": {
        "id": { "type": "string" },
        "description": { "type": "string" },
        "severity": { "type": "string", "enum": ["critical", "high", "medium", "low"] },
        "status": { "type": "string", "enum": ["open", "investigating", "resolved", "wontfix"] }
      }
    },

    "stateDecision": {
      "type": "object",
      "required": ["id", "question"],
      "properties": {
        "id": { "type": "string" },
        "question": { "type": "string" },
        "options": { "type": "array", "items": { "type": "string" } },
        "status": { "type": "string", "enum": ["open", "decided", "deferred"] },
        "decision": { "type": "string" }
      }
    },

    "familyMembership": {
      "type": "object",
      "properties": {
        "name": { "type": "string" },
        "role": { "type": "string", "enum": ["family-member", "family-lead"] },
        "family-spec": { "type": "string" },
        "shared-grammar": { "type": "string" },
        "siblings": {
          "type": "array",
          "items": { "$ref": "#/$defs/familySibling" }
        }
      }
    },

    "familySibling": {
      "type": "object",
      "required": ["name", "domain"],
      "properties": {
        "name": { "type": "string" },
        "domain": { "type": "string" },
        "media-type": { "$ref": "#/$defs/mediaType" }
      }
    },

    "relatedProject": {
      "type": "object",
      "required": ["name", "relationship"],
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "url": { "type": "string", "format": "uri" },
        "relationship": { "$ref": "#/$defs/relationshipType" },
        "description": { "type": "string" },
        "differentiation": { "type": "string" },
        "integration-notes": { "type": "string" }
      },
      "patternProperties": {
        "^x-": { "description": "Extension field" }
      }
    },

    "specificationMeta": {
      "type": "object",
      "properties": {
        "format": { "type": "string" },
        "encoding": { "type": "string", "enum": ["UTF-8"] },
        "file-extension": { "type": "string" },
        "media-type": { "$ref": "#/$defs/mediaType" },
        "grammar-definition": { "type": "string" },
        "shared-grammar": { "type": "string" },
        "json-schema": { "type": "string" },
        "internet-draft": { "type": "string" },
        "family-spec": { "type": "string" }
      }
    },

    "standardsTrack": {
      "type": "object",
      "properties": {
        "body": { "type": "string" },
        "type": { "type": "string" },
        "status": { "type": "string", "enum": ["draft", "submitted", "review", "approved", "published"] },
        "coordination": { "type": "string" },
        "roadmap": { "type": "string" }
      }
    },

    "projectType": {
      "type": "string",
      "examples": [
        "library",
        "application",
        "service",
        "specification",
        "framework",
        "tool",
        "plugin",
        "extension",
        "template"
      ]
    },

    "relationshipType": {
      "type": "string",
      "examples": [
        "consumer",
        "producer",
        "sibling",
        "sibling-standard",
        "complementary",
        "alternative",
        "inspiration",
        "fork",
        "upstream",
        "downstream",
        "potential-consumer",
        "deprecated-by",
        "deprecates"
      ]
    },

    "semver": {
      "type": "string",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-((?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\\.(?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\\+([0-9a-zA-Z-]+(?:\\.[0-9a-zA-Z-]+)*))?$"
    },

    "datetime": {
      "type": "string",
      "format": "date-time"
    },

    "mediaType": {
      "type": "string",
      "pattern": "^[a-z]+/[a-z0-9.+-]+$"
    }
  }
}
