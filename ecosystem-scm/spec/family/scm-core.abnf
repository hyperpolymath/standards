; SCM Format Family - Shared ABNF Core
; SPDX-License-Identifier: PMPL-1.0
; SPDX-FileCopyrightText: 2025 Jonathan D.A. Jewell
;
; This file defines the common ABNF primitives shared by all SCM family
; formats (STATE.scm, ECOSYSTEM.scm, and future members).
;
; Conformant implementations MUST support these primitives.
; Individual format specifications MAY extend but MUST NOT contradict.
;
; Version: 1.0.0

; =============================================================================
; DOCUMENT STRUCTURE
; =============================================================================

; Generic SCM document - specific formats constrain the root-form
scm-document = *comment root-form *comment

root-form = "(" format-identifier 1*WSP form-body ")"

format-identifier = "state"      ; STATE.scm
                  / "ecosystem"  ; ECOSYSTEM.scm
                  / identifier   ; Future formats

form-body = *( form / comment )

; =============================================================================
; S-EXPRESSION PRIMITIVES
; =============================================================================

sexp = atom / list / string

atom = identifier / number / boolean / keyword

list = "(" *( sexp / WSP / comment ) ")"

; =============================================================================
; IDENTIFIERS
; =============================================================================

identifier = identifier-start *identifier-char

identifier-start = ALPHA / "_"

identifier-char = ALPHA / DIGIT / "-" / "_" / "." / "/"

; Special identifiers
keyword = ":" identifier

; =============================================================================
; STRINGS
; =============================================================================

string = DQUOTE *string-char DQUOTE

string-char = unescaped-char / escaped-char

unescaped-char = %x20-21        ; space through !
               / %x23-5B        ; # through [
               / %x5D-7E        ; ] through ~
               / utf8-char      ; Non-ASCII UTF-8

escaped-char = "\" escape-code

escape-code = DQUOTE            ; \"  quotation mark
            / "\"               ; \\  reverse solidus
            / "/"               ; \/  solidus (optional)
            / "b"               ; \b  backspace
            / "f"               ; \f  form feed
            / "n"               ; \n  line feed
            / "r"               ; \r  carriage return
            / "t"               ; \t  tab
            / "u" 4HEXDIG       ; \uXXXX unicode

; Multiline strings use the same syntax
; Implementations SHOULD preserve internal whitespace
multiline-string = string

; =============================================================================
; NUMBERS
; =============================================================================

number = integer / decimal / scientific

integer = [ "-" / "+" ] 1*DIGIT

decimal = [ "-" / "+" ] 1*DIGIT "." 1*DIGIT

scientific = decimal ( "e" / "E" ) [ "-" / "+" ] 1*DIGIT

; =============================================================================
; BOOLEANS
; =============================================================================

boolean = true-val / false-val

true-val = "#t" / "#true" / "#T" / "#TRUE"

false-val = "#f" / "#false" / "#F" / "#FALSE"

; =============================================================================
; COMMON FORM PATTERNS
; =============================================================================

; Named form: (name value)
named-form = "(" identifier 1*WSP sexp ")"

; Property form: (key value)
property-form = "(" identifier 1*WSP sexp ")"

; List form: (name item*)
list-form = "(" identifier *( WSP sexp ) ")"

; Extension form: (x-vendor-field value)
extension-form = "(" extension-id 1*WSP sexp ")"

extension-id = "x-" 1*( ALPHA / DIGIT / "-" )

; =============================================================================
; SEMANTIC STRING TYPES
; =============================================================================

; URI per RFC 3986
uri-string = string
; Constraint: MUST be valid URI

; Semantic Version per semver.org 2.0.0
semver-string = string
; Constraint: MUST match semver pattern

; ISO 8601 datetime
datetime-string = string
; Constraint: MUST be valid ISO 8601

; Media type per RFC 6838
mediatype-string = string
; Constraint: MUST be valid media type

; SPDX license expression
spdx-string = string
; Constraint: SHOULD be valid SPDX expression

; =============================================================================
; COMMENTS
; =============================================================================

comment = line-comment / block-comment

; Line comment: semicolon to end of line
line-comment = ";" *line-char line-end

line-char = %x20-7E / utf8-char

line-end = LF / CR / CRLF / EOF

EOF = ""  ; End of input

; Block comment: #| ... |# (nestable)
block-comment = "#|" block-content "|#"

block-content = *( block-text / block-comment )

block-text = 1*( %x00-7B / %x7D-10FFFF )  ; Any except | followed by #
           / "|" %x00-22
           / "|" %x24-10FFFF

; =============================================================================
; WHITESPACE
; =============================================================================

WSP = 1*ws-char

ws-char = SP / HTAB / LF / CR

SP = %x20           ; Space
HTAB = %x09         ; Horizontal tab
LF = %x0A           ; Line feed
CR = %x0D           ; Carriage return
CRLF = CR LF        ; Windows newline

; =============================================================================
; UTF-8 ENCODING
; =============================================================================

; UTF-8 continuation bytes
utf8-char = utf8-2 / utf8-3 / utf8-4

utf8-2 = %xC2-DF utf8-tail

utf8-3 = %xE0 %xA0-BF utf8-tail
       / %xE1-EC 2utf8-tail
       / %xED %x80-9F utf8-tail
       / %xEE-EF 2utf8-tail

utf8-4 = %xF0 %x90-BF 2utf8-tail
       / %xF1-F3 3utf8-tail
       / %xF4 %x80-8F 2utf8-tail

utf8-tail = %x80-BF

; =============================================================================
; CORE ABNF RULES (RFC 5234)
; =============================================================================

ALPHA = %x41-5A / %x61-7A   ; A-Z / a-z

DIGIT = %x30-39             ; 0-9

HEXDIG = DIGIT
       / "A" / "B" / "C" / "D" / "E" / "F"
       / "a" / "b" / "c" / "d" / "e" / "f"

DQUOTE = %x22               ; "

VCHAR = %x21-7E             ; Visible characters

; =============================================================================
; SEMANTIC CONSTRAINTS (non-ABNF, for implementers)
; =============================================================================

; 1. Documents MUST be valid UTF-8
; 2. The root-form identifier determines the format type
; 3. Extension fields (x-*) MUST be ignored if not understood
; 4. Unknown forms within known containers SHOULD be preserved
; 5. Parsers SHOULD limit nesting depth (recommended: 100)
; 6. Parsers SHOULD limit document size (recommended: 10MB)
; 7. String content MUST NOT contain unescaped control characters
;    except LF and HTAB (which are permitted in multiline strings)

; =============================================================================
; INTEROPERABILITY NOTES
; =============================================================================

; JSON Mapping:
;   - Lists become arrays
;   - Named forms become objects with single key
;   - Atoms become strings, numbers, or booleans
;   - Comments are lost
;   - Extensions map to "x-*" keys

; Round-trip:
;   - Implementations SHOULD preserve comments when possible
;   - Whitespace within strings MUST be preserved
;   - Formatting whitespace MAY be normalised

; =============================================================================
; EXAMPLES
; =============================================================================

; Minimal valid documents:
;
; (state (metadata (version "2.0")))
;
; (ecosystem (version "1.0.0") (name "x") (type "lib") (purpose "y"))

; Extension usage:
;
; (ecosystem
;   (name "project")
;   (x-acme-id "12345")           ; Vendor extension
;   (x-exp-feature #t))           ; Experimental extension
