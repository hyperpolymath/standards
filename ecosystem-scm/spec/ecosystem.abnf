; ECOSYSTEM.scm ABNF Grammar
; SPDX-License-Identifier: PMPL-1.0
; SPDX-FileCopyrightText: 2025 Jonathan D.A. Jewell
;
; Formal syntax specification following RFC 5234 (ABNF)
; This grammar defines the ECOSYSTEM.scm format for describing
; software project ecosystems and inter-project relationships.
;
; Version: 1.0.0-draft

; =============================================================================
; TOP-LEVEL STRUCTURE
; =============================================================================

ecosystem-document = *comment ecosystem-form *comment

ecosystem-form = "(" "ecosystem" 1*WSP ecosystem-body ")"

ecosystem-body = *( form / comment )

; =============================================================================
; CORE FORMS
; =============================================================================

form = version-form
     / name-form
     / type-form
     / purpose-form
     / position-form
     / related-projects-form
     / what-this-is-form
     / what-this-is-not-form
     / specification-form
     / future-integration-form
     / extension-form

; Required forms
version-form = "(" "version" 1*WSP string ")"

name-form = "(" "name" 1*WSP string ")"

type-form = "(" "type" 1*WSP type-value ")"

type-value = string  ; Recommended: "library" / "application" / "service"
                     ;              "specification" / "framework" / "tool"
                     ;              "plugin" / "extension" / "template"

purpose-form = "(" "purpose" 1*WSP string ")"

; Optional forms
position-form = "(" "position-in-ecosystem" 1*WSP string ")"

what-this-is-form = "(" "what-this-is" 1*WSP string ")"

what-this-is-not-form = "(" "what-this-is-not" 1*WSP string ")"

future-integration-form = "(" "future-integration" 1*WSP string ")"

; =============================================================================
; RELATED PROJECTS
; =============================================================================

related-projects-form = "(" "related-projects" *WSP *project-form ")"

project-form = "(" "project" 1*WSP project-body ")"

project-body = *( project-field / comment )

project-field = project-name
              / project-url
              / project-relationship
              / project-description
              / project-differentiation
              / project-integration-notes
              / project-extension

project-name = "(" "name" 1*WSP string ")"

project-url = "(" "url" 1*WSP url-string ")"

project-relationship = "(" "relationship" 1*WSP relationship-type ")"

relationship-type = string  ; Recommended values:
                           ; "consumer"        - Uses this project
                           ; "producer"        - This project uses it
                           ; "sibling"         - Same ecosystem/organization
                           ; "sibling-standard"- Related specification
                           ; "complementary"   - Works alongside
                           ; "alternative"     - Competing solution
                           ; "inspiration"     - Design influence
                           ; "fork"            - Derived from
                           ; "upstream"        - Original source
                           ; "downstream"      - Derivative
                           ; "potential-consumer" - May use in future
                           ; "deprecated-by"   - Superseded by
                           ; "deprecates"      - Supersedes another

project-description = "(" "description" 1*WSP string ")"

project-differentiation = "(" "differentiation" 1*WSP string ")"

project-integration-notes = "(" "integration-notes" 1*WSP string ")"

project-extension = "(" identifier 1*WSP sexp ")"

; =============================================================================
; SPECIFICATION METADATA
; =============================================================================

specification-form = "(" "specification" *WSP specification-body ")"

specification-body = *( specification-field / comment )

specification-field = spec-format
                    / spec-encoding
                    / spec-file-extension
                    / spec-media-type
                    / spec-grammar-definition
                    / spec-json-schema
                    / spec-extension

spec-format = "(" "format" 1*WSP string ")"

spec-encoding = "(" "encoding" 1*WSP string ")"

spec-file-extension = "(" "file-extension" 1*WSP string ")"

spec-media-type = "(" "media-type" 1*WSP media-type-string ")"

spec-grammar-definition = "(" "grammar-definition" 1*WSP string ")"

spec-json-schema = "(" "json-schema" 1*WSP string ")"

spec-extension = "(" identifier 1*WSP sexp ")"

; =============================================================================
; EXTENSION MECHANISM
; =============================================================================

; Extensions allow vendor-specific or experimental fields
; Extension identifiers SHOULD use namespaced format: "x-vendor-field"

extension-form = "(" extension-identifier 1*WSP sexp ")"

extension-identifier = "x-" identifier

; =============================================================================
; PRIMITIVE TYPES
; =============================================================================

string = DQUOTE *string-char DQUOTE

string-char = %x20-21        ; space through !
            / %x23-5B        ; # through [
            / %x5D-7E        ; ] through ~
            / %x80-10FFFF    ; UTF-8 continuation
            / escape-seq

escape-seq = "\" ( DQUOTE / "\" / "/" / "b" / "f" / "n" / "r" / "t" )
           / "\u" 4HEXDIG

url-string = string  ; MUST contain valid URI per RFC 3986

media-type-string = string  ; MUST follow RFC 6838 media type syntax

identifier = ALPHA *( ALPHA / DIGIT / "-" / "_" )

; =============================================================================
; S-EXPRESSION PRIMITIVES
; =============================================================================

sexp = atom / list / string

atom = identifier / number / boolean

list = "(" *( sexp / WSP / comment ) ")"

number = [ "-" ] 1*DIGIT [ "." 1*DIGIT ]

boolean = "#t" / "#f" / "#true" / "#false"

; =============================================================================
; COMMENTS
; =============================================================================

comment = line-comment / block-comment

line-comment = ";" *( %x20-7E / %x80-10FFFF ) ( LF / CR / CRLF )

block-comment = "#|" *( block-comment-char / block-comment ) "|#"

block-comment-char = %x00-7B / %x7D-10FFFF  ; Any char except |
                   / "|" %x00-22 / "|" %x24-10FFFF  ; | not followed by #

; =============================================================================
; WHITESPACE
; =============================================================================

WSP = SP / HTAB / LF / CR / CRLF

SP = %x20       ; space

HTAB = %x09     ; horizontal tab

LF = %x0A       ; line feed

CR = %x0D       ; carriage return

CRLF = CR LF    ; Internet standard newline

; =============================================================================
; CORE ABNF RULES (from RFC 5234)
; =============================================================================

ALPHA = %x41-5A / %x61-7A   ; A-Z / a-z

DIGIT = %x30-39             ; 0-9

HEXDIG = DIGIT / "A" / "B" / "C" / "D" / "E" / "F"
                / "a" / "b" / "c" / "d" / "e" / "f"

DQUOTE = %x22               ; "

; =============================================================================
; SEMANTIC CONSTRAINTS (non-ABNF)
; =============================================================================

; 1. An ecosystem-document MUST contain exactly one ecosystem-form
; 2. The ecosystem-form MUST contain: version, name, type, purpose
; 3. The version field MUST follow Semantic Versioning 2.0.0
; 4. The url field MUST be a valid URI per RFC 3986
; 5. The media-type field MUST follow RFC 6838 syntax
; 6. Extension fields MUST use "x-" prefix
; 7. Relationship types SHOULD use recommended values for interoperability
; 8. All strings MUST be valid UTF-8

; =============================================================================
; EXAMPLES
; =============================================================================

; Minimal valid document:
;
; (ecosystem
;   (version "1.0.0")
;   (name "my-project")
;   (type "library")
;   (purpose "Does something useful"))

; Full document with all fields: see ECOSYSTEM.scm in repository root
