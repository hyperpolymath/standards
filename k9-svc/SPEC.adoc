// SPDX-License-Identifier: PMPL-1.0-or-later
= K9 SVC Specification
:subtitle: Self-Validating Components for Multi-Architecture Permanence
:author: hyperpolymath
:revnumber: 1.0.0-alpha
:revdate: 2026-01-16
:toc: left
:toclevels: 3
:icons: font
:source-highlighter: rouge
:sectnums:

== Abstract

This specification defines the `.k9` file format—a Self-Validating Component (SVC)
architecture designed to replace passive, opaque file types with active,
self-validating, and environment-aware components.

The format operates via the **must-just-nickel** triad: environment detection (must),
task orchestration (Just), and typed validation (Nickel).

== Status

[cols="1,2"]
|===
|Standard ID |`application/vnd.k9+nickel`
|Version |1.0.0-alpha
|Stability |Alpha
|Magic Number |`K9!` (`\x4B\x39\x21`)
|===

== Problem Statement

Traditional file formats are **passive containers**. They rely entirely on external
host applications to interpret, validate, and deploy their content.

This creates several failure modes:

[horizontal]
Bit Rot:: Data survives but the logic to interpret it dies, especially on
specialized environments like Minix, ASICs, or Edge nodes.

Platform Lock-in:: Files require specific applications (MS Office, Adobe, etc.)
to function, creating vendor dependencies.

Silent Corruption:: Invalid data isn't detected until runtime failure, often
after critical decisions have been made.

Deprecation Treadmill:: Formats evolve, old versions become unreadable, and
migration is manual and error-prone.

== Solution: The Active Pedigree

The `.k9` format introduces **agency as a document property**.

By embedding the must-just-nickel triad, a `.k9` file carries its own
"digestive system." It doesn't just store data—it stores the contracts
(Nickel) to validate it and the recipes (Just) to deploy it.

=== The Dogfooding Principle

A `.k9` repository is "Alpha-Ready." This means the repository uses its own
format to manage itself. The build system, the MIME registration, and the
documentation are all generated by the `.k9` components within the repo.

If the file can't "eat its own config," it refuses to run.

== Technical Architecture

=== Layer Model

[cols="1,2,3,3"]
|===
|Level |Name |Component |Function

|L1
|The Scent
|Magic Number + MIME
|OS/kernel-level recognition

|L2
|The Brain
|Nickel Contracts
|Logical integrity and security enforcement

|L3
|The Muscle
|Just Recipes
|Multi-platform deployment (ASIC to PC)

|L4
|The Pack
|SVC Interface
|Living document / dogfooding lifecycle
|===

=== L1: The Scent (Identity)

Every `.k9` file begins with a magic number for immediate kernel identification:

[source]
----
Offset: 0x00
Value:  0x4B 0x39 0x21 (ASCII: "K9!")
----

MIME registration uses Freedesktop XML on Linux/Minix and UTI plists on macOS.

=== L2: The Brain (Nickel Contracts)

Nickel provides typed, functional configuration. Key contracts:

[source,nickel]
----
let SecurityLevel = [| 'Kennel, 'Yard, 'Hunt |] in
let Architecture = [| 'Linux, 'Minix, 'MacOS, 'Android, 'PC, 'ASIC |] in

K9Pedigree = {
  metadata | Metadata,
  target | Target,
  security | Security,
  validation | Validation,
  recipes | Recipes,
}
----

All data must pass these contracts before deployment.

=== L3: The Muscle (Just Orchestration)

Just recipes handle environment-specific deployment:

[source,just]
----
deploy:
    @if command -v podman >/dev/null 2>&1; then \
        just deploy-podman; \
    else \
        just deploy-native; \
    fi
----

Podman-first deployment prevents host pollution while supporting native fallback.

== Security Model

=== The Leash System

To prevent abuse, `.k9` mandates tiered execution levels:

[cols="1,2,3"]
|===
|Level |Name |Permissions

|`'Kennel`
|Pure Data
|No execution. Read-only. Safe to open anywhere.

|`'Yard`
|Validation Only
|Nickel evaluation permitted. No filesystem/network access.

|`'Hunt`
|Full Execution
|Complete triad execution. Requires cryptographic handshake.
|===

=== Dependability Collapse Prevention

**Dependability Collapse** occurs when security mitigations become so heavy
that users bypass them entirely, or the system fails its primary function.

K9 prevents this through:

[horizontal]
Contract Isolation:: Even if a Just recipe is compromised, it can only act
on resources explicitly granted by the Nickel contracts.

Fail-Fast Validation:: Invalid components refuse to execute rather than
proceeding with corrupt data.

Sandboxed Evaluation:: Nickel evaluation is functionally pure—no side effects
until explicitly permitted.

=== Threat Model

[cols="1,2,2"]
|===
|Threat |Vector |Mitigation

|Malicious Payload
|Crafted `.k9` with hostile Just recipe
|`'Hunt` level requires signed handshake

|Interop Monoculture
|Single Nickel vulnerability affects all platforms
|Contract isolation limits blast radius

|Complexity Exhaustion
|Validation too heavy for Edge/ASIC
|`'Kennel` mode for constrained environments
|===

== Repository Requirements

To be listed as a conforming `.k9` repository:

[cols="1,3"]
|===
|File |Purpose

|`pedigree.ncl`
|Root Nickel file defining component breed, version, and security level

|`justfile`
|Cookbook containing `install`, `validate`, `deploy` recipes

|`must`
|Bootstrap script ensuring triad executes on target architecture

|`README.adoc`
|Human-readable entry point with bash bootstrap command

|`SPEC.adoc`
|This specification document (optional but recommended)
|===

== Path to MIME Recognition

=== Linux (Freedesktop)

[source,xml]
----
<mime-type type="application/vnd.k9+nickel">
  <comment>K9 Self-Validating Component</comment>
  <magic priority="50">
    <match value="K9!" type="string" offset="0"/>
  </magic>
  <glob pattern="*.k9"/>
</mime-type>
----

Location: `/usr/share/mime/packages/k9.xml`

=== macOS (UTI)

[source,xml]
----
<key>UTTypeIdentifier</key>
<string>org.k9-svc.component</string>
<key>public.mime-type</key>
<string>application/vnd.k9+nickel</string>
----

=== Minix

Static mapping in `/etc/mime.types`:

[source]
----
application/vnd.k9+nickel    k9
----

== Philosophy

The `.k9` format treats documents as **Living Entities**.

Where the MS Office suite locks data into proprietary silos, K9 liberates it.
Whether being read by a human via AsciiDoc or deployed to an ASIC via Just,
the integrity of the data remains absolute.

[quote]
A `.k9` file is not a document you open; it is a component you unleash.

== Appendix: The Triad in Detail

=== Must (Environment Shim)

POSIX shell script that:

1. Detects OS and architecture
2. Identifies edge/constrained environments
3. Ensures Nickel and Just are installed
4. Exports environment variables to the triad

=== Just (Task Runner)

Recipes for:

- MIME registration (`register-user`, `register-system`)
- Validation (`validate`, `validate-all`)
- Deployment (`deploy`, `deploy-podman`, `deploy-native`)
- Dogfooding (`dogfood`)

=== Nickel (Validation Engine)

Contracts for:

- Component metadata (name, version, breed)
- Target environment (OS, architecture, edge mode)
- Security level (Kennel/Yard/Hunt)
- Self-validation (checksum, pedigree version)
- Deployment recipes (install, validate, deploy, migrate)

== References

* https://nickel-lang.org[Nickel Language]
* https://just.systems[Just Task Runner]
* https://specifications.freedesktop.org/shared-mime-info-spec/[Freedesktop MIME Spec]
* https://developer.apple.com/documentation/uniformtypeidentifiers[Apple UTI Documentation]

== License

SPDX-License-Identifier: PMPL-1.0-or-later-or-later
