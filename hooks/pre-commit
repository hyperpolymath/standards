#!/usr/bin/env bash
# SPDX-License-Identifier: AGPL-3.0-or-later
# pre-commit hook for Hyperpolymath Language Policy enforcement
# Install: cp hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

ERRORS=0

echo "Hyperpolymath Pre-commit Checks"
echo "================================"

# Check for banned file types in staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check for TypeScript
TS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx)$' | grep -v '\.d\.ts$' || true)
if [ -n "$TS_FILES" ]; then
    echo -e "${RED}✗ TypeScript files not allowed. Use ReScript instead.${NC}"
    echo "$TS_FILES"
    ERRORS=$((ERRORS + 1))
fi

# Check for Go
GO_FILES=$(echo "$STAGED_FILES" | grep -E '\.go$' || true)
if [ -n "$GO_FILES" ]; then
    echo -e "${RED}✗ Go files not allowed. Use Rust instead.${NC}"
    echo "$GO_FILES"
    ERRORS=$((ERRORS + 1))
fi

# Check for Python (except Ansible)
PY_FILES=$(echo "$STAGED_FILES" | grep -E '\.py$' | grep -v 'ansible' | grep -v 'molecule' || true)
if [ -n "$PY_FILES" ]; then
    echo -e "${RED}✗ Python files not allowed (except for Ansible). Rewrite in Rust/ReScript.${NC}"
    echo "$PY_FILES"
    ERRORS=$((ERRORS + 1))
fi

# Check for Makefiles
MAKEFILES=$(echo "$STAGED_FILES" | grep -iE '(^|/)Makefile(\.|$)|\.mk$' | grep -v '.github' || true)
if [ -n "$MAKEFILES" ]; then
    echo -e "${RED}✗ Makefiles not allowed. Use Mustfile/justfile instead.${NC}"
    echo "$MAKEFILES"
    ERRORS=$((ERRORS + 1))
fi

# Check for Java/Kotlin
JVM_FILES=$(echo "$STAGED_FILES" | grep -E '\.(java|kt|kts)$' || true)
if [ -n "$JVM_FILES" ]; then
    echo -e "${RED}✗ Java/Kotlin files not allowed. Use Rust/Tauri/Dioxus instead.${NC}"
    echo "$JVM_FILES"
    ERRORS=$((ERRORS + 1))
fi

# Check for Swift
SWIFT_FILES=$(echo "$STAGED_FILES" | grep -E '\.swift$' || true)
if [ -n "$SWIFT_FILES" ]; then
    echo -e "${RED}✗ Swift files not allowed. Use Tauri/Dioxus instead.${NC}"
    echo "$SWIFT_FILES"
    ERRORS=$((ERRORS + 1))
fi

# Check for SPDX headers on source files
SOURCE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(rs|res|js|jsx|mjs|sh|bash|zig|ex|exs|gleam|ml|mli|adb|ads|ncl)$' || true)
for file in $SOURCE_FILES; do
    if [ -f "$file" ] && ! head -5 "$file" | grep -q "SPDX-License-Identifier"; then
        echo -e "${YELLOW}⚠ Missing SPDX header: $file${NC}"
    fi
done

# Final result
echo ""
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}Pre-commit check failed with $ERRORS error(s)${NC}"
    echo ""
    echo "See: https://github.com/hyperpolymath/standards for language policy"
    exit 1
else
    echo -e "${GREEN}✓ All pre-commit checks passed${NC}"
fi
