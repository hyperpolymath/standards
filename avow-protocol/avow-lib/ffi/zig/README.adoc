= libstamp Zig FFI
Jonathan D.A. Jewell <jonathan.jewell@open.ac.uk>
:toc:
:zig-version: 0.13.0

== Overview

This directory contains the Zig FFI implementation for libstamp, providing a stable C ABI that can be called from any language.

== Building

=== Prerequisites

* Zig {zig-version}+ (https://ziglang.org/download/)
* Basic understanding of C FFI

=== Build Commands

[source,bash]
----
# Build library
zig build

# Run tests
zig build test

# Run example
zig build example

# Install system-wide (optional)
zig build --prefix /usr/local
----

**Output:**
```
zig-out/
├── lib/
│   ├── libstamp.so      # Linux
│   ├── libstamp.dylib   # macOS
│   └── stamp.dll        # Windows
└── include/
    └── stamp.h          # C header
```

== Usage

=== From C/C++

[source,c]
----
#include <stamp.h>
#include <stdio.h>

int main() {
    StampUnsubscribeParams params = {
        .url = "https://example.com/unsub",
        .tested_at = 1706630400000,
        .response_code = 200,
        .response_time = 87,
        .token = "abc123...",
        .signature = "sig...",
    };

    StampResult result = stamp_verify_unsubscribe(&params);
    if (result == STAMP_SUCCESS) {
        printf("Valid unsubscribe link!\n");
    } else {
        printf("Verification failed: %d\n", result);
    }

    return 0;
}
----

**Compile:**
[source,bash]
----
gcc -o myapp myapp.c -L./zig-out/lib -lstamp -I./zig-out/include
export LD_LIBRARY_PATH=./zig-out/lib  # Linux
export DYLD_LIBRARY_PATH=./zig-out/lib  # macOS
./myapp
----

=== From Rust

See `examples/rust/` for complete example.

[source,rust]
----
use std::ffi::CString;

#[link(name = "stamp")]
extern "C" {
    fn stamp_verify_unsubscribe(params: *const StampUnsubscribeParams) -> c_int;
}

fn main() {
    let url = CString::new("https://example.com/unsub").unwrap();
    let token = CString::new("abc123...").unwrap();
    let sig = CString::new("signature...").unwrap();

    let params = StampUnsubscribeParams {
        url: url.as_ptr(),
        tested_at: 1706630400000,
        response_code: 200,
        response_time: 87,
        token: token.as_ptr(),
        signature: sig.as_ptr(),
    };

    let result = unsafe { stamp_verify_unsubscribe(&params) };
    println!("Result: {}", result);
}
----

**Build:**
[source,bash]
----
cd examples/rust
cargo build
cargo run
----

=== From Python

See `examples/python/` for complete example.

[source,python]
----
import ctypes

libstamp = ctypes.CDLL('./zig-out/lib/libstamp.so')

# Define structures
class StampUnsubscribeParams(ctypes.Structure):
    _fields_ = [
        ("url", ctypes.c_char_p),
        ("tested_at", ctypes.c_uint64),
        ("response_code", ctypes.c_uint16),
        ("response_time", ctypes.c_uint32),
        ("token", ctypes.c_char_p),
        ("signature", ctypes.c_char_p),
    ]

# Call function
params = StampUnsubscribeParams(
    url=b"https://example.com/unsub",
    tested_at=1706630400000,
    response_code=200,
    response_time=87,
    token=b"abc123...",
    signature=b"sig...",
)

result = libstamp.stamp_verify_unsubscribe(ctypes.byref(params))
print(f"Result: {result}")
----

**Run:**
[source,bash]
----
python3 examples/python/stamp_example.py
----

=== From JavaScript/Deno

[source,javascript]
----
// Deno FFI
const libstamp = Deno.dlopen("./zig-out/lib/libstamp.so", {
    stamp_verify_unsubscribe: {
        parameters: ["pointer"],
        result: "i32",
    },
});

const params = new Uint8Array(64);  // Serialize params
const result = libstamp.symbols.stamp_verify_unsubscribe(params);
console.log(`Result: ${result}`);
----

== API Reference

=== Result Codes

[cols="1,1,3"]
|===
|Code |Name |Description

|0
|STAMP_SUCCESS
|Verification passed

|-1
|STAMP_ERROR_INVALID_URL
|URL format is invalid (not HTTPS)

|-2
|STAMP_ERROR_TIMEOUT
|Test was not recent OR response was too slow

|-3
|STAMP_ERROR_INVALID_RESPONSE
|HTTP response code was not 200 OK

|-4
|STAMP_ERROR_INVALID_SIGNATURE
|Cryptographic signature is invalid

|-5
|STAMP_ERROR_RATE_LIMIT_EXCEEDED
|Sender has exceeded daily message limit

|-6
|STAMP_ERROR_CONSENT_INVALID
|Consent chain is invalid (timing or token)

|-7
|STAMP_ERROR_NULL_POINTER
|NULL pointer passed to function

|-99
|STAMP_ERROR_INTERNAL
|Internal error
|===

=== Functions

==== stamp_verify_unsubscribe()

Verifies an unsubscribe link is valid.

**Checks:**
* URL format is valid (HTTPS)
* Test was recent (< 60 seconds ago)
* HTTP response was 200 OK
* Response time was fast (< 200ms)
* Signature is valid

[source,c]
----
StampResult stamp_verify_unsubscribe(const StampUnsubscribeParams* params);
----

==== stamp_verify_consent()

Verifies a consent chain (double opt-in).

**Checks:**
* Confirmation happened AFTER initial request
* Confirmation was timely (< 24 hours)
* Token is cryptographically valid

[source,c]
----
StampResult stamp_verify_consent(const StampConsentParams* params);
----

==== stamp_verify_rate_limit()

Verifies sender is within rate limits.

**Checks:**
* Messages today < daily limit
* Daily limit appropriate for account age:
  - < 30 days: max 1,000/day
  - 30-90 days: max 10,000/day
  - 90+ days: max 100,000/day

[source,c]
----
StampResult stamp_verify_rate_limit(const StampRateLimitParams* params);
----

==== stamp_generate_proof()

Generates a JSON proof of verification.

**Returns:** Pointer to `StampProof` (must be freed with `stamp_free_proof()`)

[source,c]
----
StampProof* stamp_generate_proof(const StampUnsubscribeParams* params);
----

==== stamp_free_proof()

Frees a proof returned by `stamp_generate_proof()`.

[source,c]
----
void stamp_free_proof(StampProof* proof);
----

==== stamp_version()

Returns library version string.

[source,c]
----
const char* stamp_version(void);
----

== Testing

Run the test suite:

[source,bash]
----
zig build test
----

Tests include:
* Valid unsubscribe verification
* Invalid URL detection
* Slow response detection
* Valid consent chain
* Invalid consent order detection
* Rate limit compliance
* Rate limit exceeded detection
* Proof generation and freeing

== Architecture

[source]
----
Application (Rust/Python/JS)
           ↓
    C FFI (stamp.h)
           ↓
    Zig FFI (main.zig)
           ↓
    Idris2 ABI (../../../src/abi/*.idr)
           ↓
    Dependent Type Proofs
----

The Zig layer:
1. Provides stable C ABI
2. Handles memory management
3. Wraps Idris2 verification functions
4. Exports to all languages

## Performance

**Benchmarks** (Release build, Intel i7):
* Unsubscribe verification: ~500 ns
* Consent verification: ~300 ns
* Rate limit verification: ~200 ns
* Proof generation: ~50 µs

**Memory:**
* Zero allocations per verification (stack-only)
* Proof generation allocates once (freed by caller)

== Troubleshooting

=== Library not found

**Linux:**
[source,bash]
----
export LD_LIBRARY_PATH=/path/to/zig-out/lib:$LD_LIBRARY_PATH
----

**macOS:**
[source,bash]
----
export DYLD_LIBRARY_PATH=/path/to/zig-out/lib:$DYLD_LIBRARY_PATH
----

**Or install system-wide:**
[source,bash]
----
zig build --prefix /usr/local
sudo ldconfig  # Linux only
----

=== Build errors

1. **Check Zig version:**
   ```bash
   zig version  # Should be 0.13.0+
   ```

2. **Clean and rebuild:**
   ```bash
   rm -rf zig-cache zig-out
   zig build
   ```

3. **Check for compiler errors:**
   ```bash
   zig build 2>&1 | less
   ```

=== Runtime errors

1. **Enable debug logging:**
   ```bash
   zig build -Doptimize=Debug
   ```

2. **Run with valgrind** (memory leaks):
   ```bash
   valgrind --leak-check=full ./zig-out/bin/example
   ```

3. **Check ABI compatibility:**
   ```bash
   nm zig-out/lib/libstamp.so | grep stamp_
   ```

== Contributing

See `../../CONTRIBUTING.md` for contribution guidelines.

**Code style:**
* Follow Zig standard library style
* Run `zig fmt` before committing
* Add tests for new features
* Document public API

== License

AGPL-3.0-or-later

== Author

Jonathan D.A. Jewell <jonathan.jewell@open.ac.uk>
