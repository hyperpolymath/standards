// Protocol Buffers schema for Palimpsest License metadata
// Syntax: proto3
// Package: palimpsest.metadata.v1

syntax = "proto3";

package palimpsest.metadata.v1;

option go_package = "github.com/palimpsest-license/metadata/gen/go/v1;metadatav1";
option java_package = "org.palimpsest.license.metadata.v1";
option java_multiple_files = true;
option csharp_namespace = "Palimpsest.Metadata.V1";

import "google/protobuf/timestamp.proto";

// ============================================================================
// Common Types
// ============================================================================

// Multilingual text with language codes
message MultilingualText {
  map<string, string> translations = 1; // ISO 639-1 language codes
}

// Semantic version
message Version {
  uint32 major = 1;
  uint32 minor = 2;
  uint32 patch = 3;

  enum Status {
    STATUS_UNSPECIFIED = 0;
    DRAFT = 1;
    IN_DEVELOPMENT = 2;
    STABLE = 3;
    DEPRECATED = 4;
    ARCHIVED = 5;
  }
  Status status = 4;
}

// Creator or contributor information
message Person {
  string name = 1;
  string uri = 2;
  string email = 3;
  string orcid = 4; // ORCID identifier
  string wallet_address = 5; // Blockchain wallet
  string public_key = 6; // Cryptographic public key
}

// Quantum-proof cryptographic signature
message QuantumProof {
  enum Algorithm {
    ALGORITHM_UNSPECIFIED = 0;
    SPHINCS_PLUS = 1;
    CRYSTALS_DILITHIUM = 2;
    FALCON = 3;
    OTHER = 99;
  }

  Algorithm algorithm = 1;
  bytes signature = 2;
  bytes public_key = 3;
  google.protobuf.Timestamp signed_at = 4;
  string key_id = 5;
  bytes merkle_root = 6; // For Merkle tree verification
  repeated bytes merkle_proof = 7;
}

// Blockchain/DLT record
message BlockchainRecord {
  string network = 1; // e.g., "Ethereum", "Polygon"
  string transaction_hash = 2;
  uint64 block_number = 3;
  string contract_address = 4;
  google.protobuf.Timestamp timestamp = 5;
}

// Decentralised storage identifiers
message DecentralisedStorage {
  string ipfs_hash = 1;
  string arweave_id = 2;
  string filecoin_cid = 3;
  map<string, string> other_identifiers = 4;
}

// ============================================================================
// License Metadata
// ============================================================================

message License {
  string license_id = 1; // e.g., "palimpsest-v0.4"
  Version version = 2;
  MultilingualText title = 3;
  MultilingualText description = 4;

  // Governance structure
  message Governance {
    string council_name = 1;
    uint32 member_count = 2;
    string draft_voting_threshold = 3; // e.g., "4/7"
    string ratification_voting_threshold = 4; // e.g., "5/7"
    string major_version_voting_threshold = 5; // e.g., "6/7"
    uint32 consultation_period_days = 6;
    string consultation_period_description = 7;
  }
  Governance governance = 5;

  // Protection features
  message Protection {
    bool emotional_lineage = 1;
    bool quantum_proof_traceability = 2;
    bool symbolic_attribution = 3;
    bool ai_consent_required = 4;
    bool metadata_preservation_mandatory = 5;
  }
  Protection protection = 6;

  // Legal jurisdiction
  message Jurisdiction {
    string primary_country = 1;
    string enforcement_venue = 2;
    string governing_law = 3;
    repeated string dispute_resolution_methods = 4;
    string international_framework = 5;
  }
  Jurisdiction jurisdiction = 7;

  // Metadata
  string canonical_uri = 8;
  string doi = 9;
  string spdx_identifier = 10;
  google.protobuf.Timestamp created_at = 11;
  google.protobuf.Timestamp modified_at = 12;
  google.protobuf.Timestamp published_at = 13;

  // Relations
  string replaces_license_id = 14;
  string superseded_by_license_id = 15;
}

// ============================================================================
// Creative Work Metadata
// ============================================================================

message Work {
  string work_id = 1;
  string canonical_uri = 2;
  string license_id = 3;
  string license_version = 4;

  MultilingualText title = 5;
  MultilingualText description = 6;

  Person creator = 7;

  // Emotional lineage
  message EmotionalLineage {
    string context = 1;
    repeated string themes = 2;

    enum Sensitivity {
      SENSITIVITY_UNSPECIFIED = 0;
      TRAUMA = 1;
      CULTURAL_HERITAGE = 2;
      SACRED = 3;
      PROTEST = 4;
      DIASPORA = 5;
      INDIGENOUS = 6;
      OTHER = 99;
    }
    repeated Sensitivity sensitivities = 3;

    message SymbolicElement {
      string symbol = 1;
      string meaning = 2;
      string cultural_origin = 3;
    }
    repeated SymbolicElement symbolic_elements = 4;
  }
  EmotionalLineage emotional_lineage = 8;

  // Thematic integrity
  message ThematicIntegrity {
    repeated string core_themes = 1;

    enum ProhibitedUse {
      PROHIBITED_USE_UNSPECIFIED = 0;
      TRIVIALISATION = 1;
      COMMODIFICATION = 2;
      MISREPRESENTATION = 3;
      FLATTENING = 4;
    }
    repeated ProhibitedUse prohibited_uses = 2;
    string interpretation_notes = 3;
  }
  ThematicIntegrity thematic_integrity = 9;

  // AI consent
  message AIConsent {
    bool training_allowed = 1;
    bool generation_allowed = 2;
    repeated string conditions = 3;
    repeated string exceptions = 4;
    google.protobuf.Timestamp expiry_date = 5;
  }
  AIConsent ai_consent = 10;

  // Work metadata
  message WorkMetadata {
    string work_type = 1;
    string medium = 2;
    repeated string genre = 3;
    repeated string language = 4;
    repeated string tags = 5;
    string doi = 6;
    string isbn = 7;
    string issn = 8;
    map<string, string> external_identifiers = 9;
  }
  WorkMetadata work_metadata = 11;

  // Accessibility
  message Accessibility {
    repeated string formats_available = 1;
    bool screen_reader_compatible = 2;
    string plain_language_summary = 3;
    string low_bandwidth_version_uri = 4;
    string accessibility_notes = 5;
  }
  Accessibility accessibility = 12;

  // Quantum-proof tracking
  string quantum_proof_hash = 13;
  QuantumProof quantum_proof = 14;

  // Timestamps
  google.protobuf.Timestamp created_at = 15;
  google.protobuf.Timestamp modified_at = 16;
  google.protobuf.Timestamp published_at = 17;
  google.protobuf.Timestamp registered_at = 18;

  enum Status {
    STATUS_UNSPECIFIED = 0;
    DRAFT = 1;
    PUBLISHED = 2;
    ARCHIVED = 3;
    DISPUTED = 4;
  }
  Status status = 19;

  // Relations
  string parent_work_id = 20;
  string collection_id = 21;
}

// ============================================================================
// Derivative Work Metadata
// ============================================================================

message Derivative {
  string derivative_id = 1;
  string canonical_uri = 2;
  string license_id = 3;
  string license_version = 4;

  MultilingualText title = 5;

  // Original work reference
  message OriginalWork {
    string uri = 1;
    string work_id = 2;
    string creator = 3;
    string title = 4;
  }
  OriginalWork original_work = 6;

  Person derivative_creator = 7;

  // Lineage statement (required by Clause 3.2)
  message LineageStatement {
    enum AttributionType {
      ATTRIBUTION_TYPE_UNSPECIFIED = 0;
      DIRECT = 1;
      INDIRECT = 2;
      ENVIRONMENTAL = 3;
      SYMBOLIC = 4;
    }

    message Attribution {
      AttributionType type = 1;
      string content = 2;
      bool preserves_context = 3;
      string display_format = 4;
    }
    Attribution attribution = 1;

    enum TransformationType {
      TRANSFORMATION_TYPE_UNSPECIFIED = 0;
      REMIX = 1;
      TRANSLATION = 2;
      ADAPTATION = 3;
      COMMENTARY = 4;
      EXTENSION = 5;
    }

    message Transformation {
      TransformationType type = 1;
      string description = 2;
      bool preserves_integrity = 3;
      string technical_details = 4;
    }
    repeated Transformation transformations = 2;

    enum ReciprocityType {
      RECIPROCITY_TYPE_UNSPECIFIED = 0;
      PERCENTAGE_SHARE = 1;
      ARCHIVE_CREDIT = 2;
      ATTRIBUTION = 3;
      OTHER = 99;
    }

    message Reciprocity {
      bool offered = 1;
      ReciprocityType type = 2;
      string details = 3;
      string contract_uri = 4;
      float amount_percentage = 5;
    }
    Reciprocity reciprocity = 3;
  }
  LineageStatement lineage_statement = 8;

  bool commercial_use = 9;

  // Synthetic/AI lineage tag (required for AI-generated works)
  message SyntheticLineageTag {
    bool is_synthetic = 1;
    string ai_system = 2;
    string model_name = 3;
    string model_version = 4;
    bool training_consent_verified = 5;
    google.protobuf.Timestamp generation_date = 6;
    string quantum_proof_hash = 7;
    string prompt_used = 8;
    bool human_oversight = 9;
    bool post_generation_editing = 10;
  }
  SyntheticLineageTag synthetic_lineage_tag = 10;

  // Compliance verification
  message Compliance {
    bool thematic_integrity_preserved = 1;
    bool symbolic_attribution_provided = 2;
    bool metadata_preserved = 3;
    bool accessibility_maintained = 4;
    google.protobuf.Timestamp review_date = 5;
    string reviewer = 6;
    string notes = 7;
  }
  Compliance compliance = 11;

  // Timestamps
  google.protobuf.Timestamp created_at = 12;
  google.protobuf.Timestamp published_at = 13;
  google.protobuf.Timestamp registered_at = 14;

  enum Status {
    STATUS_UNSPECIFIED = 0;
    DRAFT = 1;
    PUBLISHED = 2;
    DISPUTED = 3;
    REVOKED = 4;
  }
  Status status = 15;
}

// ============================================================================
// Lineage Chain
// ============================================================================

message Lineage {
  string lineage_id = 1;

  // Root work (original)
  message RootWork {
    string uri = 1;
    string work_id = 2;
    string creator = 3;
    string title = 4;
    google.protobuf.Timestamp created_at = 5;
  }
  RootWork root_work = 2;

  // Chain of transformations
  enum TransformationType {
    TRANSFORMATION_TYPE_UNSPECIFIED = 0;
    ORIGINAL = 1;
    REMIX = 2;
    TRANSLATION = 3;
    ADAPTATION = 4;
    COMMENTARY = 5;
    EXTENSION = 6;
    DERIVATIVE = 7;
  }

  message ChainLink {
    string uri = 1;
    string work_id = 2;
    string creator = 3;
    string title = 4;
    google.protobuf.Timestamp timestamp = 5;
    TransformationType transformation_type = 6;
    uint32 generation_number = 7;
    string parent_uri = 8;
    bytes hash = 9;
  }
  repeated ChainLink chain = 3;

  // Quantum-proof verification
  QuantumProof quantum_proof = 4;

  // Blockchain/DLT integration
  BlockchainRecord blockchain = 5;

  // Decentralised storage
  DecentralisedStorage decentralised_storage = 6;

  // Verification status
  bool verified = 7;
  google.protobuf.Timestamp verification_date = 8;
  string verifier = 9;

  // Metadata
  uint32 total_generations = 10;
  uint32 branch_count = 11;
  google.protobuf.Timestamp last_update = 12;
}

// ============================================================================
// Usage Tracking
// ============================================================================

message Usage {
  string work_uri = 1;

  enum UsageType {
    USAGE_TYPE_UNSPECIFIED = 0;
    VIEW = 1;
    REMIX = 2;
    DERIVATIVE = 3;
    COMMERCIAL = 4;
    AI_TRAINING = 5;
    AI_GENERATION = 6;
  }
  UsageType usage_type = 2;

  enum UserType {
    USER_TYPE_UNSPECIFIED = 0;
    INDIVIDUAL = 1;
    ORGANISATION = 2;
    AI_SYSTEM = 3;
    ANONYMOUS = 4;
  }

  message User {
    string identifier = 1;
    UserType type = 2;
  }
  User user = 3;

  google.protobuf.Timestamp timestamp = 4;
  bool compliant = 5;
  map<string, string> details = 6;
}

// ============================================================================
// Violation Tracking
// ============================================================================

message Violation {
  string violation_id = 1;
  string work_uri = 2;
  string work_id = 3;
  string work_title = 4;

  enum ViolationType {
    VIOLATION_TYPE_UNSPECIFIED = 0;
    ATTRIBUTION_FAILURE = 1;
    METADATA_STRIPPING = 2;
    CULTURAL_MISREPRESENTATION = 3;
    UNAUTHORISED_AI_TRAINING = 4;
    UNAUTHORISED_AI_GENERATION = 5;
    TRIVIALISATION = 6;
    COMMODIFICATION = 7;
    FLATTENING = 8;
    ACCESSIBILITY_BREACH = 9;
    RECIPROCITY_FAILURE = 10;
    OTHER = 99;
  }
  ViolationType violation_type = 5;

  string description = 6;
  string detailed_explanation = 7;

  // Reporter information
  enum Relationship {
    RELATIONSHIP_UNSPECIFIED = 0;
    CREATOR = 1;
    RIGHTS_HOLDER = 2;
    COMMUNITY_MEMBER = 3;
    THIRD_PARTY = 4;
    AUTOMATED_SYSTEM = 5;
  }

  message Reporter {
    string name = 1;
    string email = 2;
    string uri = 3;
    Relationship relationship = 4;
    bool anonymous = 5;
  }
  Reporter reported_by = 8;

  // Alleged violator
  message AllegedViolator {
    string name = 1;
    string organisation = 2;
    string uri = 3;
    bool contact_attempted = 4;
    google.protobuf.Timestamp contact_date = 5;
    bool response_received = 6;
  }
  AllegedViolator alleged_violator = 9;

  // Evidence
  enum EvidenceType {
    EVIDENCE_TYPE_UNSPECIFIED = 0;
    URL = 1;
    SCREENSHOT = 2;
    DOCUMENT = 3;
    TESTIMONY = 4;
    TECHNICAL_ANALYSIS = 5;
    BLOCKCHAIN_RECORD = 6;
  }

  message Evidence {
    EvidenceType type = 1;
    string content = 2;
    string uri = 3;
    string ipfs_hash = 4;
    string description = 5;
    google.protobuf.Timestamp collected_at = 6;
  }
  repeated Evidence evidence = 10;

  // Status tracking
  enum Status {
    STATUS_UNSPECIFIED = 0;
    REPORTED = 1;
    UNDER_REVIEW = 2;
    PANEL_REVIEW = 3;
    RESOLVED = 4;
    DISMISSED = 5;
    ESCALATED = 6;
  }
  Status status = 11;

  enum Priority {
    PRIORITY_UNSPECIFIED = 0;
    LOW = 1;
    MEDIUM = 2;
    HIGH = 3;
    CRITICAL = 4;
  }
  Priority priority = 12;

  // Timeline
  google.protobuf.Timestamp reported_at = 13;
  google.protobuf.Timestamp review_started_at = 14;
  google.protobuf.Timestamp panel_assigned_at = 15;
  google.protobuf.Timestamp resolved_at = 16;

  // Panel review (Clause 8.2)
  message PanelReview {
    bool assigned = 1;
    repeated string panel_members = 2;
    string licensor_representative = 3;
    repeated string community_representatives = 4;
    google.protobuf.Timestamp review_date = 5;
    string findings = 6;
    string recommendation = 7;
    uint32 vote_for = 8;
    uint32 vote_against = 9;
    uint32 vote_abstain = 10;
  }
  PanelReview panel_review = 17;

  // Resolution
  enum ResolutionOutcome {
    RESOLUTION_OUTCOME_UNSPECIFIED = 0;
    VIOLATION_CONFIRMED = 1;
    NO_VIOLATION = 2;
    SETTLED = 3;
    ONGOING = 4;
    DISMISSED = 5;
  }

  message Resolution {
    ResolutionOutcome outcome = 1;
    string outcome_description = 2;
    repeated string remediation_required = 3;
    bool remediation_completed = 4;
    google.protobuf.Timestamp remediation_date = 5;
    bool compensation_offered = 6;
    string compensation_details = 7;
    bool public_apology_required = 8;
    bool public_apology_issued = 9;
    bool archived_in_symbolic_defence = 10;
    string archive_uri = 11;
  }
  Resolution resolution = 18;

  // Legal action
  message LegalAction {
    bool initiated = 1;
    string jurisdiction = 2;
    string case_number = 3;
    google.protobuf.Timestamp filing_date = 4;
    string status = 5;
    string outcome = 6;
  }
  LegalAction legal_action = 19;

  string internal_notes = 20;
  string assigned_to = 21;
}

// ============================================================================
// Metadata Collections
// ============================================================================

message MetadataCollection {
  repeated License licenses = 1;
  repeated Work works = 2;
  repeated Derivative derivatives = 3;
  repeated Lineage lineages = 4;
  repeated Usage usages = 5;
  repeated Violation violations = 6;

  google.protobuf.Timestamp collected_at = 7;
  string collection_version = 8;
}
