{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "$id": "https://palimpsest.license/schemas/ndjson/v0.4",
  "title": "Palimpsest License NDJSON Schema",
  "description": "JSON Schema for Palimpsest License metadata in newline-delimited JSON format",
  "type": "object",
  "definitions": {
    "licenseMetadata": {
      "type": "object",
      "required": ["id", "type", "version", "title", "timestamp"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for this metadata record",
          "pattern": "^palimpsest-v[0-9]+\\.[0-9]+(-[a-z0-9-]+)?$"
        },
        "type": {
          "type": "string",
          "enum": ["license", "work", "derivative", "lineage", "usage", "violation"],
          "description": "Type of metadata record"
        },
        "version": {
          "type": "object",
          "required": ["major", "minor"],
          "properties": {
            "major": {
              "type": "integer",
              "minimum": 0
            },
            "minor": {
              "type": "integer",
              "minimum": 0
            },
            "patch": {
              "type": "integer",
              "minimum": 0,
              "default": 0
            },
            "status": {
              "type": "string",
              "enum": ["draft", "in-development", "stable", "deprecated", "archived"]
            }
          }
        },
        "title": {
          "type": "object",
          "required": ["en"],
          "properties": {
            "en": {
              "type": "string"
            },
            "nl": {
              "type": "string"
            }
          },
          "additionalProperties": {
            "type": "string"
          }
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of record creation or modification"
        }
      }
    },
    "work": {
      "allOf": [
        {"$ref": "#/definitions/licenseMetadata"},
        {
          "type": "object",
          "required": ["creator", "uri"],
          "properties": {
            "creator": {
              "type": "object",
              "required": ["name"],
              "properties": {
                "name": {
                  "type": "string"
                },
                "uri": {
                  "type": "string",
                  "format": "uri"
                },
                "email": {
                  "type": "string",
                  "format": "email"
                },
                "orcid": {
                  "type": "string",
                  "pattern": "^[0-9]{4}-[0-9]{4}-[0-9]{4}-[0-9]{3}[0-9X]$"
                }
              }
            },
            "uri": {
              "type": "string",
              "format": "uri",
              "description": "Canonical URI of the work"
            },
            "description": {
              "type": "object",
              "additionalProperties": {
                "type": "string"
              }
            },
            "emotionalLineage": {
              "type": "object",
              "properties": {
                "context": {
                  "type": "string",
                  "description": "Cultural or emotional context of the work"
                },
                "themes": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                },
                "sensitivities": {
                  "type": "array",
                  "items": {
                    "type": "string",
                    "enum": ["trauma", "cultural-heritage", "sacred", "protest", "diaspora", "indigenous", "other"]
                  }
                },
                "symbolicElements": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "required": ["symbol", "meaning"],
                    "properties": {
                      "symbol": {
                        "type": "string"
                      },
                      "meaning": {
                        "type": "string"
                      },
                      "culturalOrigin": {
                        "type": "string"
                      }
                    }
                  }
                }
              }
            },
            "thematicIntegrity": {
              "type": "object",
              "properties": {
                "coreThemes": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                },
                "prohibitedUses": {
                  "type": "array",
                  "items": {
                    "type": "string",
                    "enum": ["trivialisation", "commodification", "misrepresentation", "flattening"]
                  }
                }
              }
            },
            "aiConsent": {
              "type": "object",
              "required": ["training", "generation"],
              "properties": {
                "training": {
                  "type": "boolean",
                  "description": "Consent for AI training"
                },
                "generation": {
                  "type": "boolean",
                  "description": "Consent for AI-generated derivatives"
                },
                "conditions": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                }
              }
            },
            "metadata": {
              "type": "object",
              "description": "Additional metadata that must be preserved",
              "properties": {
                "created": {
                  "type": "string",
                  "format": "date-time"
                },
                "modified": {
                  "type": "string",
                  "format": "date-time"
                },
                "tags": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                },
                "doi": {
                  "type": "string"
                },
                "orcid": {
                  "type": "string"
                }
              }
            }
          }
        }
      ]
    },
    "derivative": {
      "allOf": [
        {"$ref": "#/definitions/licenseMetadata"},
        {
          "type": "object",
          "required": ["originalWork", "derivativeCreator", "lineageStatement"],
          "properties": {
            "originalWork": {
              "type": "object",
              "required": ["uri"],
              "properties": {
                "uri": {
                  "type": "string",
                  "format": "uri"
                },
                "creator": {
                  "type": "string"
                },
                "title": {
                  "type": "string"
                }
              }
            },
            "derivativeCreator": {
              "type": "object",
              "required": ["name"],
              "properties": {
                "name": {
                  "type": "string"
                },
                "uri": {
                  "type": "string",
                  "format": "uri"
                }
              }
            },
            "lineageStatement": {
              "type": "object",
              "required": ["attribution", "transformations"],
              "properties": {
                "attribution": {
                  "type": "object",
                  "required": ["type", "content"],
                  "properties": {
                    "type": {
                      "type": "string",
                      "enum": ["direct", "indirect", "environmental", "symbolic"]
                    },
                    "content": {
                      "type": "string"
                    },
                    "preservesContext": {
                      "type": "boolean"
                    }
                  }
                },
                "transformations": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "required": ["type", "description"],
                    "properties": {
                      "type": {
                        "type": "string",
                        "enum": ["remix", "translation", "adaptation", "commentary", "extension"]
                      },
                      "description": {
                        "type": "string"
                      },
                      "preservesIntegrity": {
                        "type": "boolean"
                      }
                    }
                  }
                },
                "reciprocity": {
                  "type": "object",
                  "properties": {
                    "offered": {
                      "type": "boolean"
                    },
                    "type": {
                      "type": "string",
                      "enum": ["percentage-share", "archive-credit", "attribution", "other"]
                    },
                    "details": {
                      "type": "string"
                    }
                  }
                }
              }
            },
            "commercial": {
              "type": "boolean",
              "description": "Whether the derivative is for commercial use"
            },
            "syntheticLineageTag": {
              "type": "object",
              "description": "Required for AI-generated derivatives",
              "properties": {
                "aiSystem": {
                  "type": "string"
                },
                "model": {
                  "type": "string"
                },
                "trainingConsent": {
                  "type": "boolean"
                },
                "generationDate": {
                  "type": "string",
                  "format": "date-time"
                },
                "quantumProofHash": {
                  "type": "string",
                  "description": "Quantum-resistant cryptographic hash"
                }
              }
            }
          }
        }
      ]
    },
    "lineage": {
      "type": "object",
      "required": ["rootWork", "chain", "timestamp"],
      "properties": {
        "rootWork": {
          "type": "object",
          "required": ["uri"],
          "properties": {
            "uri": {
              "type": "string",
              "format": "uri"
            },
            "creator": {
              "type": "string"
            }
          }
        },
        "chain": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["uri", "creator", "timestamp"],
            "properties": {
              "uri": {
                "type": "string",
                "format": "uri"
              },
              "creator": {
                "type": "string"
              },
              "timestamp": {
                "type": "string",
                "format": "date-time"
              },
              "transformationType": {
                "type": "string"
              }
            }
          }
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "quantumProof": {
          "type": "object",
          "properties": {
            "algorithm": {
              "type": "string",
              "enum": ["SPHINCS+", "CRYSTALS-Dilithium", "Falcon", "other"]
            },
            "signature": {
              "type": "string"
            },
            "publicKey": {
              "type": "string"
            }
          }
        }
      }
    },
    "usage": {
      "type": "object",
      "required": ["workUri", "usageType", "timestamp"],
      "properties": {
        "workUri": {
          "type": "string",
          "format": "uri"
        },
        "usageType": {
          "type": "string",
          "enum": ["view", "remix", "derivative", "commercial", "ai-training", "ai-generation"]
        },
        "user": {
          "type": "object",
          "properties": {
            "identifier": {
              "type": "string"
            },
            "type": {
              "type": "string",
              "enum": ["individual", "organisation", "ai-system", "anonymous"]
            }
          }
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "compliant": {
          "type": "boolean",
          "description": "Whether the usage complies with license terms"
        },
        "details": {
          "type": "object",
          "additionalProperties": true
        }
      }
    },
    "violation": {
      "type": "object",
      "required": ["workUri", "violationType", "reportedBy", "timestamp"],
      "properties": {
        "workUri": {
          "type": "string",
          "format": "uri"
        },
        "violationType": {
          "type": "string",
          "enum": [
            "attribution-failure",
            "metadata-stripping",
            "cultural-misrepresentation",
            "unauthorised-ai-training",
            "trivialisation",
            "commodification",
            "flattening",
            "other"
          ]
        },
        "reportedBy": {
          "type": "object",
          "required": ["name"],
          "properties": {
            "name": {
              "type": "string"
            },
            "email": {
              "type": "string",
              "format": "email"
            },
            "relationship": {
              "type": "string",
              "enum": ["creator", "rights-holder", "community-member", "third-party"]
            }
          }
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "description": {
          "type": "string"
        },
        "evidence": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "enum": ["url", "screenshot", "document", "testimony"]
              },
              "content": {
                "type": "string"
              }
            }
          }
        },
        "status": {
          "type": "string",
          "enum": ["reported", "under-review", "resolved", "dismissed"],
          "default": "reported"
        },
        "resolution": {
          "type": "object",
          "properties": {
            "outcome": {
              "type": "string"
            },
            "timestamp": {
              "type": "string",
              "format": "date-time"
            },
            "remediation": {
              "type": "string"
            }
          }
        }
      }
    }
  },
  "oneOf": [
    {"$ref": "#/definitions/work"},
    {"$ref": "#/definitions/derivative"},
    {"$ref": "#/definitions/lineage"},
    {"$ref": "#/definitions/usage"},
    {"$ref": "#/definitions/violation"}
  ]
}
