{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://meta.scm/schema/v1.0/meta.schema.json",
  "title": "META Format Schema",
  "description": "JSON Schema for META (Machine-readable Engineering and Technical Architecture) files - validates the JSON binding of META format",
  "type": "object",
  "required": ["module", "architecture-decisions"],
  "properties": {
    "module": {
      "$ref": "#/$defs/module"
    },
    "architecture-decisions": {
      "$ref": "#/$defs/architectureDecisions"
    },
    "development-practices": {
      "$ref": "#/$defs/developmentPractices"
    },
    "design-rationale": {
      "$ref": "#/$defs/designRationale"
    }
  },
  "additionalProperties": {
    "description": "Extension sections are allowed",
    "type": ["object", "array", "string"]
  },

  "$defs": {
    "module": {
      "type": "string",
      "description": "Module path in the form 'project-name/meta'",
      "pattern": "^[a-z][a-z0-9-]*(/[a-z][a-z0-9-]*)*$",
      "examples": ["example-api/meta", "my-project/meta"]
    },

    "architectureDecisions": {
      "type": "array",
      "description": "List of Architecture Decision Records (ADRs)",
      "items": {
        "$ref": "#/$defs/adr"
      },
      "minItems": 0,
      "uniqueItems": true
    },

    "adr": {
      "type": "object",
      "description": "Architecture Decision Record",
      "required": ["id", "title", "status", "date", "context", "decision"],
      "properties": {
        "id": {
          "$ref": "#/$defs/adrId"
        },
        "title": {
          "type": "string",
          "description": "Short descriptive title",
          "minLength": 1,
          "maxLength": 200
        },
        "status": {
          "$ref": "#/$defs/adrStatus"
        },
        "date": {
          "$ref": "#/$defs/isoDate"
        },
        "context": {
          "type": "string",
          "description": "Problem or situation that prompted the decision",
          "minLength": 1
        },
        "decision": {
          "type": "string",
          "description": "What was decided",
          "minLength": 1
        },
        "consequences": {
          "type": "array",
          "description": "Resulting implications",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "minItems": 1
        },
        "supersedes": {
          "description": "ADR ID(s) this decision supersedes",
          "oneOf": [
            { "$ref": "#/$defs/adrId" },
            {
              "type": "array",
              "items": { "$ref": "#/$defs/adrId" },
              "minItems": 1
            }
          ]
        },
        "superseded-by": {
          "$ref": "#/$defs/adrId"
        },
        "deciders": {
          "type": "array",
          "description": "People involved in the decision",
          "items": {
            "type": "string",
            "minLength": 1
          }
        },
        "references": {
          "type": "array",
          "description": "Related URLs or documents",
          "items": {
            "type": "string",
            "format": "uri"
          }
        }
      },
      "additionalProperties": true
    },

    "adrId": {
      "type": "string",
      "description": "ADR identifier in the form adr-NNN",
      "pattern": "^adr-[0-9]{3,}$",
      "examples": ["adr-001", "adr-042", "adr-100"]
    },

    "adrStatus": {
      "type": "string",
      "description": "Current status of the ADR",
      "enum": ["proposed", "accepted", "deprecated", "superseded", "rejected"]
    },

    "developmentPractices": {
      "type": "object",
      "description": "Development standards and practices by category",
      "properties": {
        "code-style": {
          "$ref": "#/$defs/codeStylePractice"
        },
        "security": {
          "$ref": "#/$defs/securityPractice"
        },
        "documentation": {
          "$ref": "#/$defs/documentationPractice"
        },
        "testing": {
          "$ref": "#/$defs/testingPractice"
        },
        "versioning": {
          "$ref": "#/$defs/versioningPractice"
        },
        "deployment": {
          "$ref": "#/$defs/deploymentPractice"
        },
        "review": {
          "$ref": "#/$defs/reviewPractice"
        },
        "branching": {
          "$ref": "#/$defs/branchingPractice"
        }
      },
      "additionalProperties": {
        "description": "Extension categories are allowed",
        "type": "object"
      }
    },

    "codeStylePractice": {
      "type": "object",
      "description": "Code formatting and style settings",
      "properties": {
        "formatter": {
          "type": "string",
          "description": "Code formatter tool",
          "examples": ["prettier", "black", "rustfmt", "deno fmt"]
        },
        "linter": {
          "type": "string",
          "description": "Linter tool",
          "examples": ["eslint", "clippy", "pylint", "deno lint"]
        },
        "type-system": {
          "type": "string",
          "description": "Type system or type checker",
          "examples": ["TypeScript", "mypy", "Rust", "ReScript"]
        },
        "line-length": {
          "type": "integer",
          "description": "Maximum line length",
          "minimum": 40,
          "maximum": 200
        },
        "indent": {
          "type": "string",
          "description": "Indentation style",
          "enum": ["spaces", "tabs"]
        },
        "indent-size": {
          "type": "integer",
          "description": "Number of spaces for indentation",
          "minimum": 1,
          "maximum": 8
        }
      },
      "additionalProperties": true
    },

    "securityPractice": {
      "type": "object",
      "description": "Security requirements and practices",
      "properties": {
        "command-execution": {
          "type": "string",
          "description": "Policy for executing external commands"
        },
        "input-validation": {
          "type": "string",
          "description": "Input validation strategy"
        },
        "credentials": {
          "type": "string",
          "description": "Credential management policy"
        },
        "dependencies": {
          "type": "string",
          "description": "Dependency security policy"
        }
      },
      "additionalProperties": true
    },

    "documentationPractice": {
      "type": "object",
      "description": "Documentation requirements",
      "properties": {
        "format": {
          "type": "string",
          "description": "Documentation format",
          "examples": ["Markdown", "AsciiDoc", "reStructuredText"]
        },
        "api-docs": {
          "type": "string",
          "description": "API documentation approach",
          "examples": ["OpenAPI 3.1", "JSDoc", "rustdoc"]
        },
        "adr-location": {
          "type": "string",
          "description": "Where ADRs are stored"
        },
        "changelog": {
          "type": "string",
          "description": "Changelog format"
        }
      },
      "additionalProperties": true
    },

    "testingPractice": {
      "type": "object",
      "description": "Testing strategy and requirements",
      "properties": {
        "framework": {
          "type": "string",
          "description": "Testing framework",
          "examples": ["jest", "pytest", "cargo test", "Deno.test"]
        },
        "coverage-minimum": {
          "type": "integer",
          "description": "Minimum code coverage percentage",
          "minimum": 0,
          "maximum": 100
        },
        "unit-tests": {
          "type": "string",
          "description": "Unit testing requirements"
        },
        "integration-tests": {
          "type": "string",
          "description": "Integration testing requirements"
        },
        "e2e-tests": {
          "type": "string",
          "description": "End-to-end testing requirements"
        },
        "property-testing": {
          "type": "string",
          "description": "Property-based testing approach"
        },
        "mutation-testing": {
          "type": "string",
          "description": "Mutation testing approach"
        }
      },
      "additionalProperties": true
    },

    "versioningPractice": {
      "type": "object",
      "description": "Version numbering and release practices",
      "properties": {
        "scheme": {
          "type": "string",
          "description": "Versioning scheme",
          "examples": ["Semantic Versioning 2.0.0", "CalVer", "Custom"]
        },
        "changelog": {
          "type": "string",
          "description": "Changelog format",
          "examples": ["Keep a Changelog format", "Conventional Commits"]
        },
        "release-process": {
          "type": "string",
          "description": "Release process description"
        }
      },
      "additionalProperties": true
    },

    "deploymentPractice": {
      "type": "object",
      "description": "Deployment procedures",
      "properties": {
        "strategy": {
          "type": "string",
          "description": "Deployment strategy",
          "examples": ["blue-green", "rolling", "canary", "recreate"]
        },
        "environments": {
          "type": "array",
          "description": "Deployment environments",
          "items": {
            "type": "string"
          },
          "examples": [["development", "staging", "production"]]
        },
        "infrastructure": {
          "type": "string",
          "description": "Infrastructure platform"
        },
        "ci-cd": {
          "type": "string",
          "description": "CI/CD platform"
        }
      },
      "additionalProperties": true
    },

    "reviewPractice": {
      "type": "object",
      "description": "Code review process",
      "properties": {
        "required-approvals": {
          "type": "integer",
          "description": "Number of required approvals",
          "minimum": 0
        },
        "automated-checks": {
          "type": "array",
          "description": "Required automated checks",
          "items": {
            "type": "string"
          }
        },
        "guidelines": {
          "type": "string",
          "description": "Review guidelines reference"
        }
      },
      "additionalProperties": true
    },

    "branchingPractice": {
      "type": "object",
      "description": "Git branching strategy",
      "properties": {
        "strategy": {
          "type": "string",
          "description": "Branching strategy",
          "examples": ["trunk-based", "git-flow", "github-flow"]
        },
        "main-branch": {
          "type": "string",
          "description": "Name of main branch",
          "examples": ["main", "master"]
        },
        "feature-prefix": {
          "type": "string",
          "description": "Feature branch prefix",
          "examples": ["feature/", "feat/"]
        },
        "release-prefix": {
          "type": "string",
          "description": "Release branch prefix",
          "examples": ["release/", "rel/"]
        }
      },
      "additionalProperties": true
    },

    "designRationale": {
      "type": "object",
      "description": "Design rationale entries keyed by topic",
      "additionalProperties": {
        "type": "string",
        "description": "Explanatory text for the design decision",
        "minLength": 1
      }
    },

    "isoDate": {
      "type": "string",
      "description": "ISO 8601 date",
      "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$",
      "examples": ["2025-01-15", "2025-12-01"]
    },

    "semver": {
      "type": "string",
      "description": "Semantic version string",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-((?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\\.(?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\\+([0-9a-zA-Z-]+(?:\\.[0-9a-zA-Z-]+)*))?$",
      "examples": ["1.0.0", "2.1.0-beta.1", "0.9.0+build.123"]
    }
  }
}
