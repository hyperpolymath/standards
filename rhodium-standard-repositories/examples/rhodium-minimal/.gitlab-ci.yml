# SPDX-License-Identifier: MPL-2.0-or-later
# SPDX-FileCopyrightText: 2025 The Rhodium Standard Contributors
#
# GitLab CI/CD Pipeline for rhodium-minimal
# Minimal RSR-compliant example

# Workflow rules
workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
    - if: $CI_COMMIT_BRANCH

# Global variables
variables:
  RUST_VERSION: "1.75.0"
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  CACHE_COMPRESSION_LEVEL: "fastest"

# Default image
image: rust:${RUST_VERSION}

# Cache dependencies
cache:
  key:
    files:
      - Cargo.lock
  paths:
    - .cargo/
    - target/

# Stages
stages:
  - validate
  - build
  - test
  - release

# ============================================================================
# Validation Stage
# ============================================================================

spdx-audit:
  stage: validate
  image: alpine:latest
  before_script:
    - apk add --no-cache ripgrep just
  script:
    - echo "ðŸ“‹ Auditing SPDX headers..."
    - just audit-licence
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

format-check:
  stage: validate
  script:
    - echo "ðŸ“ Checking code formatting..."
    - cargo fmt -- --check
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

lint:
  stage: validate
  script:
    - echo "ðŸ” Running Clippy..."
    - cargo clippy -- -D warnings
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

check-unsafe:
  stage: validate
  image: alpine:latest
  before_script:
    - apk add --no-cache ripgrep just
  script:
    - echo "ðŸ”’ Checking for unsafe code..."
    - just check-unsafe
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

check-docs:
  stage: validate
  image: alpine:latest
  before_script:
    - apk add --no-cache just
  script:
    - echo "ðŸ“š Checking required documentation..."
    - just check-docs
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# ============================================================================
# Build Stage
# ============================================================================

build-debug:
  stage: build
  script:
    - echo "ðŸ”¨ Building rhodium-minimal (debug)..."
    - cargo build
  artifacts:
    paths:
      - target/debug/rhodium-minimal
    expire_in: 1 day
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

build-release:
  stage: build
  script:
    - echo "ðŸ”¨ Building rhodium-minimal (release)..."
    - cargo build --release
  artifacts:
    paths:
      - target/release/rhodium-minimal
    expire_in: 7 days
  only:
    - main
    - tags

# ============================================================================
# Test Stage
# ============================================================================

test:
  stage: test
  dependencies:
    - build-debug
  script:
    - echo "ðŸ§ª Running tests..."
    - cargo test --verbose
  coverage: '/\d+\.\d+% coverage/'
  artifacts:
    reports:
      junit: test-results.xml
    expire_in: 7 days
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

# Full RSR compliance validation
rsr-compliance:
  stage: test
  image: alpine:latest
  before_script:
    - apk add --no-cache ripgrep just cargo rust
  script:
    - echo "âœ… Running RSR compliance validation..."
    - just validate || echo "âš ï¸  Compliance issues found"
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

# ============================================================================
# Release Stage
# ============================================================================

release:
  stage: release
  dependencies:
    - build-release
  script:
    - echo "ðŸ“¦ Creating release artifacts..."
    - mkdir -p release
    - cp target/release/rhodium-minimal release/
    - cd release && sha256sum rhodium-minimal > SHA256SUMS
    - echo "âœ… Release artifacts created"
  artifacts:
    paths:
      - release/
    expire_in: 30 days
  only:
    - tags

# ============================================================================
# Nix Build (Optional)
# ============================================================================

nix-build:
  stage: build
  image: nixos/nix:latest
  before_script:
    - echo "experimental-features = nix-command flakes" >> /etc/nix/nix.conf
  script:
    - echo "ðŸ”¨ Building with Nix..."
    - nix build
  artifacts:
    paths:
      - result/
    expire_in: 7 days
  allow_failure: true
  only:
    - main
    - tags
