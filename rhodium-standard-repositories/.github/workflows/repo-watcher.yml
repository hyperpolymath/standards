# SPDX-License-Identifier: MPL-2.0-or-later
name: Auto-Configure New Repositories

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:      # Manual trigger

permissions: read-all

jobs:
  configure-new-repos:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Get all repos
        id: repos
        env:
          GH_TOKEN: ${{ secrets.REPO_CONFIG_TOKEN }}
        run: |
          gh api /users/hyperpolymath/repos --paginate -q '.[].name' > all_repos.txt
          echo "Found $(wc -l < all_repos.txt) repos"

      - name: Check and configure each repo
        env:
          GH_TOKEN: ${{ secrets.REPO_CONFIG_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          BITBUCKET_TOKEN: ${{ secrets.BITBUCKET_TOKEN }}
        run: |
          while read -r repo; do
            echo "Checking $repo..."

            # Skip template repo itself
            if [ "$repo" = "rsr-template-repo" ]; then
              echo "  Skipping template repo"
              continue
            fi

            DEFAULT_BRANCH=$(gh api "/repos/hyperpolymath/$repo" -q '.default_branch' 2>/dev/null || echo "main")

            # Check if mirror.yml exists
            MIRROR_EXISTS=$(gh api "/repos/hyperpolymath/$repo/contents/.github/workflows/mirror.yml" -q '.name' 2>/dev/null || echo "")

            if [ -z "$MIRROR_EXISTS" ]; then
              echo "  Adding mirror.yml..."
              cat > /tmp/mirror.yml << 'MIRROREOF'
          # SPDX-License-Identifier: MPL-2.0-or-later
          name: Mirror to GitLab and Bitbucket

          on:
            push:
              branches: [main, master]
              tags:
                - 'v*'
            workflow_dispatch:

          permissions: read-all

          jobs:
            mirror-gitlab:
              runs-on: ubuntu-latest
              permissions:
                contents: read
              if: ${{ vars.GITLAB_MIRROR_ENABLED == 'true' }}
              steps:
                - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
                  with:
                    fetch-depth: 0
                - name: Push to GitLab
                  env:
                    GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
                    REPO_NAME: ${{ github.event.repository.name }}
                  run: |
                    git remote add gitlab https://oauth2:${GITLAB_TOKEN}@gitlab.com/hyperpolymath/${REPO_NAME}.git || true
                    git push gitlab HEAD:main --force || git push gitlab HEAD:master --force
                    git push gitlab --tags --force

            mirror-bitbucket:
              runs-on: ubuntu-latest
              permissions:
                contents: read
              if: ${{ vars.BITBUCKET_MIRROR_ENABLED == 'true' }}
              steps:
                - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
                  with:
                    fetch-depth: 0
                - name: Push to Bitbucket
                  env:
                    BITBUCKET_TOKEN: ${{ secrets.BITBUCKET_TOKEN }}
                    REPO_NAME: ${{ github.event.repository.name }}
                  run: |
                    git remote add bitbucket https://x-token-auth:${BITBUCKET_TOKEN}@bitbucket.org/hyperpolymath/${REPO_NAME}.git || true
                    git push bitbucket HEAD:main --force || git push bitbucket HEAD:master --force
                    git push bitbucket --tags --force
          MIRROREOF

              CONTENT=$(base64 -w 0 /tmp/mirror.yml)
              gh api --method PUT "/repos/hyperpolymath/$repo/contents/.github/workflows/mirror.yml" \
                -f message="Add mirror workflow (auto-configured)" \
                -f content="$CONTENT" \
                -f branch="$DEFAULT_BRANCH" 2>/dev/null && echo "  ✓ Mirror added"
            fi

            # Check if CodeQL exists
            CODEQL_EXISTS=$(gh api "/repos/hyperpolymath/$repo/contents/.github/workflows/codeql-analysis.yml" -q '.name' 2>/dev/null || echo "")

            if [ -z "$CODEQL_EXISTS" ]; then
              echo "  Adding CodeQL..."
              cat > /tmp/codeql.yml << 'CODEQLEOF'
          # SPDX-License-Identifier: MPL-2.0-or-later
          name: "CodeQL"
          on:
            push:
              branches: [ "main", "master" ]
            pull_request:
              branches: [ "main", "master" ]
            schedule:
              - cron: '30 1 * * *'

          permissions: read-all

          jobs:
            analyze:
              name: Analyze
              runs-on: ubuntu-latest
              timeout-minutes: 360
              permissions:
                security-events: write
                packages: read
                actions: read
                contents: read
              strategy:
                fail-fast: false
                matrix:
                  include:
                    - language: javascript-typescript
                      build-mode: none
                    - language: python
                      build-mode: none
              steps:
              - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
              - uses: github/codeql-action/init@48ab28a6f5dbc2a99bf1e0131198dd8f1df78169 # v3.28.0
                with:
                  languages: ${{ matrix.language }}
                  build-mode: ${{ matrix.build-mode }}
              - uses: github/codeql-action/analyze@48ab28a6f5dbc2a99bf1e0131198dd8f1df78169 # v3.28.0
                with:
                  category: "/language:${{matrix.language}}"
          CODEQLEOF

              CONTENT=$(base64 -w 0 /tmp/codeql.yml)
              gh api --method PUT "/repos/hyperpolymath/$repo/contents/.github/workflows/codeql-analysis.yml" \
                -f message="Add CodeQL workflow (auto-configured)" \
                -f content="$CONTENT" \
                -f branch="$DEFAULT_BRANCH" 2>/dev/null && echo "  ✓ CodeQL added"
            fi

            # Enable Dependabot alerts
            gh api --method PUT "/repos/hyperpolymath/$repo/vulnerability-alerts" 2>/dev/null
            gh api --method PUT "/repos/hyperpolymath/$repo/automated-security-fixes" 2>/dev/null

            # Set mirror variables if not set
            gh api "/repos/hyperpolymath/$repo/actions/variables/GITLAB_MIRROR_ENABLED" 2>/dev/null || \
              gh api --method POST "/repos/hyperpolymath/$repo/actions/variables" \
                -f name="GITLAB_MIRROR_ENABLED" -f value="true" 2>/dev/null

            gh api "/repos/hyperpolymath/$repo/actions/variables/BITBUCKET_MIRROR_ENABLED" 2>/dev/null || \
              gh api --method POST "/repos/hyperpolymath/$repo/actions/variables" \
                -f name="BITBUCKET_MIRROR_ENABLED" -f value="true" 2>/dev/null

          done < all_repos.txt

          echo "Done configuring repos!"
